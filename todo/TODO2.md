# KOMANAVI Phase 2 TODO（完了分まで整理）

## 目的
Phase 2（拡張機能）の現状完了分を整理し、未完了/追加で必ず実施すべき項目を別章に集約する。


## 完了済み（現状の実装完了範囲）

### 企画・要件整理
- [x] 漫画生成の要件（4〜8コマ、テンプレート方式、品質基準）を確定
	- 4〜8コマ、テンプレート方式（固定キャラ/背景＋セリフ差し替え）
	- 1コマ1メッセージ。文字サイズは16px相当以上、スマホ幅でも可読
	- 出力: PNG、最長辺1200px、背景コントラストを確保
	- 生成失敗時はテキスト要約にフォールバック
- [x] 履歴管理の保存方式（ローカル or サーバー）を確定
	- Phase 2 はローカルストレージ保存（サーバー側は未保存）
	- 保存期間: 90日（クライアント側で期限超過分を削除）
- [x] フィードバック収集の入力項目と保存範囲を確定
	- 入力項目: 評価（正確/不正確）、コメント任意、対象URL、生成ID、日時
	- 保存範囲: Phase 2 はローカル保存のみ（送信APIは Phase 2.3 で設計）
- [x] パーソナライズ拡充の対象ユースケースを確定
	- 優先ユースケース: 児童手当/子育て給付、転入届、介護保険
	- 質問例: 子どもの年齢、自治体、現受給/認定有無、前住所

### 非機能・運用要件
- [x] 漫画生成の非同期フロー（ジョブID・ポーリング/通知）を定義
	- API: POST /api/manga → { jobId }
	- Status API: GET /api/manga/{jobId} → { status: queued|processing|done|error, progress?, result?, error? }
	- ポーリング: 2s間隔（最大60s）、doneで停止／errorでフォールバック
	- 通知: Phase 2 はポーリングのみ（プッシュ通知はPhase 3検討）
	- 失敗時: テキスト要約へフォールバック＋再試行ボタン表示
- [x] 生成コスト上限・レート制限方針を決定
	- 生成上限: 1ユーザーあたり 1日3回まで（localStorageで回数管理）
	- クールダウン: 同一URLは10分以内の再生成を禁止
	- 同時生成: 1ジョブ/ユーザー（既存ジョブがprocessingなら新規拒否）
	- コスト監視: 日次/週次の生成数を集計（Phase 2はローカル集計のみ）
- [x] 監視項目（生成成功率・待機時間）を定義
	- 成功率: done/(done+error)
	- 待機時間: queued→done の95パーセンタイル
	- エラー種別: timeout / api_error / validation_error / unknown
	- 目標値: 成功率95%以上、P95待機時間60秒以内

### バックエンド拡張
- [x] 漫画生成 API の設計（POST /api/manga, GET /api/manga/{jobId}）
- [x] 漫画生成ジョブ管理（状態: queued/processing/done/error）
- [x] 生成結果の保存形式（画像URL群・メタデータ）
- [x] エラーハンドリング（timeout / api_error / validation_error / unknown）
- [x] 生成失敗時のフォールバック仕様（テキスト要約）
- [x] レート制限・クールダウン・同時生成制限

### 履歴管理
- [x] 履歴保存の方式決定（ローカルストレージ）
- [x] 履歴一覧取得（ローカル、ページング相当）
- [x] 履歴詳細取得（ローカル）
- [x] 保存期間（90日）に合わせた削除処理

### フロントエンド拡張
- [x] 漫画ビューア画面の作成（SCR-007）
- [x] 生成中/失敗時の表示
- [x] 「もっとわかりやすく」ボタンからの起動
- [x] 履歴一覧画面（SCR-008）
- [x] 解析結果への再遷移
- [x] 履歴削除 UI（任意）
- [x] 「この情報は正しいですか？」ボタンの実装
- [x] コメント入力（任意）
- [x] 送信完了/失敗のフィードバック
- [x] 生成結果のダウンロード導線（要約/漫画）


