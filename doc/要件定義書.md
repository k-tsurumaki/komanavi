# KOMANAVI 要件定義書

**行政情報可視化アプリケーション**

Version 2.0 ｜ 2025年1月10日

---

## 改訂履歴

| 版数 | 日付 | 作成者 | 変更内容 |
|------|------|--------|----------|
| 1.0 | 2025/01/10 | − | 初版作成 |
| 2.0 | 2025/01/10 | − | ターゲット階層化、MVP再定義、信頼性機能追加、パーソナライズ機能追加 |

---

## 1. はじめに

### 1.1 本書の目的

本書は、行政情報可視化アプリケーション「KOMANAVI」の開発に必要な要件を定義するものである。システムの目的、機能、性能、制約条件等を明確にし、開発チームおよびステークホルダー間の共通理解を形成することを目的とする。

### 1.2 プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | KOMANAVI（コマナビ） |
| プロジェクト目標 | 行政ドキュメントの要約・可視化により、情報アクセシビリティを向上させる |
| 対象ユーザー | 行政サービスを利用する市民（優先度別に階層化） |
| 開発期間 | 要相談 |

### 1.3 背景と課題

行政のWebページは制度を正確に伝えるために丁寧に記述されている。しかし、実際に困っている人ほど以下の課題に直面する。

- そもそも読む時間・気力がない
- 自分が対象かどうか分からない
- 例外条件が多く、理解が困難
- 「結局、自分の場合は？」に短時間で到達しにくい

行政情報は「平易で、国民が理解し利用できる」ことが求められる一方で、現実には前提知識や例外条件が多く、「正確に書かれているけど誰にも読まれないドキュメント」が存在し続けている。

**特に深刻な影響を受ける層**として、緊急性が高く情報弱者になりやすい人々（ひとり親、高齢者の介護者、外国人住民、災害被災者）が挙げられる。これらの層は、最も支援を必要としながら、最も情報へのアクセスが困難な状況にある。

### 1.4 用語定義

| 用語 | 定義 |
|------|------|
| KOMANAVI | 本プロジェクトで開発する行政情報可視化アプリケーション |
| 中間表現 | 元のドキュメントから抽出された構造化データ（制度概要、対象者、手続き等） |
| 要約 | 中間表現をもとに生成される、平易な言葉でまとめたMarkdownドキュメント |
| 漫画 | 中間表現をもとに生成される、ユーザーを主人公としたビジュアルコンテンツ（オプション機能） |
| パーソナライズ | ユーザーの状況に応じて要約内容をカスタマイズする機能 |

---

## 2. ターゲットユーザー

### 2.1 優先ターゲットの階層化

本システムは、以下の優先順位でターゲットユーザーを定義する。UI/UX設計および要約の難易度調整は、この優先順位に基づいて行う。

#### 第1優先：緊急性が高く情報弱者になりやすい層

| ユーザー層 | 特徴 | 想定される利用シーン |
|-----------|------|---------------------|
| ひとり親 | 時間的余裕がない、複数の支援制度を必要とする | 児童扶養手当、医療費助成、就労支援 |
| 高齢者の介護者 | 精神的・時間的負担が大きい、制度が複雑 | 介護保険、介護休業、施設入所手続き |
| 外国人住民 | 言語の壁、日本の行政制度に不慣れ | 在留資格、国民健康保険、子どもの就学 |
| 災害被災者 | 緊急性が高い、通常の判断力が低下 | 罹災証明、支援金申請、仮設住宅 |

**設計指針**
- 最もシンプルで分かりやすいUI
- 専門用語を極力排除した要約
- 大きな文字サイズ、高コントラスト
- やさしい日本語への対応を検討

#### 第2優先：ライフイベント直面者

| ユーザー層 | 特徴 | 想定される利用シーン |
|-----------|------|---------------------|
| 出産・育児中の親 | 初めての手続きが多い、睡眠不足 | 出生届、児童手当、育休給付金 |
| 転入者 | 地域固有の制度を知らない | 転入届、ゴミ出しルール、子どもの転校 |
| 失業者 | 経済的・精神的不安、複数制度の利用 | 失業保険、国民健康保険切替、住居確保給付金 |

**設計指針**
- ステップバイステップの案内
- 期限の明確な表示
- 関連制度の提案

#### 第3優先：一般市民

| ユーザー層 | 特徴 | 想定される利用シーン |
|-----------|------|---------------------|
| 一般市民 | 特定の手続きが必要な時に利用 | 確定申告、パスポート申請、各種届出 |

**設計指針**
- 効率的な情報提供
- 詳細情報へのアクセス手段

### 2.2 ターゲット別UI/UX方針

| 要素 | 第1優先向け | 第2・3優先向け |
|------|------------|---------------|
| 文字サイズ | 大（18px以上） | 標準（16px） |
| 情報量 | 最小限、段階的開示 | 詳細表示可 |
| 専門用語 | 排除（やさしい日本語） | 注釈付きで使用可 |
| ナビゲーション | 大きなボタン、シンプル | 標準的なUI |
| 視覚的補助 | アイコン多用 | 必要に応じて |

---

## 3. システム概要

### 3.1 システムの目的

KOMANAVIは、以下の機能により行政ドキュメントを人々に届きやすくすることを目的とする。

1. **要約機能（コア機能）**：難しい文書をより分かりやすい言葉で簡潔にまとめたドキュメント（Markdown）への変換
2. **チェックリスト機能（コア機能）**：次に取るべきアクションを明確化
3. **パーソナライズ機能（コア機能）**：ユーザーの状況に応じた情報のフィルタリング
4. **漫画生成機能（オプション）**：「もっとわかりやすく」を求めるユーザー向けのビジュアルコンテンツ

### 3.2 システム構成

本システムは以下のコンポーネントで構成される。

- **フロントエンド**：Webブラウザ上で動作するユーザーインターフェース
- **バックエンド**：URL解析、中間表現生成、要約生成を行うAPIサーバー
- **キャッシュ層**：URL単位での解析結果キャッシュ（24〜72時間）
- **LLM連携モジュール**：大規模言語モデルを活用した文書解析・生成エンジン
- **画像生成モジュール**：漫画コマ・キャラクターを生成するエンジン（Phase 2）
- **画像ストレージ**：生成漫画画像の保存（Cloud Storage、Phase 2）

### 3.3 利用シナリオ

**想定される利用場面**：引っ越し手続き、子育て給付、医療費助成、災害時手続き等

**基本フロー**：

```
1. ユーザーが行政ページのURLを入力
2. （キャッシュ確認）既存の解析結果があれば即座に表示
3. （新規解析の場合）KOMANAVIがページを解析し、制度の要点と根拠箇所を抽出
4. パーソナライズ質問を表示（任意回答）
5. ユーザーの状況に応じた要約とチェックリストを表示
6. （オプション）「もっとわかりやすく」ボタンで漫画を非同期生成
7. ユーザーは要約で自己判断し、チェックリストで次アクションを確定
```

---

## 4. 開発フェーズ

### 4.1 フェーズ概要

| フェーズ | 内容 | 目標期間 |
|---------|------|---------|
| Phase 1（MVP） | コア機能の実装 | 2ヶ月 |
| Phase 2 | 拡張機能の追加 | 1.5ヶ月 |
| Phase 3 | 高度機能の追加 | 2ヶ月 |

### 4.2 Phase 1（MVP）

**目標**：最小限の機能で価値を検証する

**スコープ**：
- URL入力
- ページ解析
- 中間表現生成
- 要約生成
- チェックリスト生成
- 信頼性担保機能（根拠表示、免責、原文リンク）
- パーソナライズ質問（基本）
- キャッシュ機能

**除外**：漫画生成（コストとリスクが高いため）

### 4.3 Phase 2

**目標**：ユーザー体験の向上

**スコープ**：
- 漫画生成（テンプレート方式による低コスト実装）
- 履歴管理機能
- フィードバック収集機能
- パーソナライズの拡充

### 4.4 Phase 2 要件整理（Step 1）

**要件確定事項**
- 漫画生成の要件（4〜8コマ、テンプレート方式、品質基準）
  - 4〜8コマ、テンプレート方式（固定キャラ/背景＋セリフ差し替え）
  - 1コマ1メッセージ、文字サイズ16px相当以上
  - 出力: PNG、最長辺1200px、スマホ幅で可読
  - 生成失敗時はテキスト要約にフォールバック
- 履歴管理の保存方式（ローカル or サーバー）
  - Phase 2 はローカルストレージ保存（サーバー保存は未実施）
  - 保存期間: 90日（クライアント側で期限超過分を削除）
- フィードバック収集の入力項目と保存範囲
  - 入力項目: 評価（正確/不正確）、コメント任意、対象URL、生成ID、日時
  - 保存範囲: Phase 2 はローカル保存のみ（送信APIは別途設計）
- パーソナライズ拡充の対象ユースケース
  - 優先ユースケース: 児童手当/子育て給付、転入届、介護保険
  - 質問例: 子どもの年齢、自治体、現受給/認定有無、前住所

**非機能・運用要件**
- 漫画生成の非同期フロー（ジョブID・ポーリング/通知）
  - API: POST /api/manga → { jobId }
  - Status API: GET /api/manga/{jobId} → { status: queued|processing|done|error, progress?, result?, error? }
  - ポーリング: 2s間隔（最大60s）、doneで停止／errorでフォールバック
  - 通知: Phase 2 はポーリングのみ（プッシュ通知はPhase 3検討）
  - 失敗時: テキスト要約へフォールバック＋再試行ボタン表示
- 生成コスト上限・レート制限方針
  - 生成上限: 1ユーザーあたり 1日3回まで（localStorageで回数管理）
  - クールダウン: 同一URLは10分以内の再生成を禁止
  - 同時生成: 1ジョブ/ユーザー（既存ジョブがprocessingなら新規拒否）
  - コスト監視: 日次/週次の生成数を集計（Phase 2はローカル集計のみ）
- 監視項目（生成成功率・待機時間）
  - 成功率: done/(done+error)
  - 待機時間: queued→done の95パーセンタイル
  - エラー種別: timeout / api_error / validation_error / unknown
  - 目標値: 成功率95%以上、P95待機時間60秒以内

### 4.5 Phase 3

**目標**：アクセシビリティと拡張性の向上

**スコープ**：
- SNS共有機能
- 音声読み上げ機能
- 多言語対応（やさしい日本語、英語、中国語、韓国語、ベトナム語、ポルトガル語）
- API公開

---

## 5. 機能要件

### 5.1 機能一覧

| ID | 機能名 | 概要 | Phase | 優先度 |
|----|--------|------|-------|--------|
| F-001 | URL入力 | 行政ページのURLを入力し、解析対象を指定する | 1 | 必須 |
| F-002 | ページ解析 | 指定されたURLからコンテンツを取得・解析する | 1 | 必須 |
| F-003 | 中間表現生成 | 解析結果から構造化された中間表現を生成する | 1 | 必須 |
| F-004 | 要約生成 | 中間表現から平易な要約ドキュメントを生成する | 1 | 必須 |
| F-005 | チェックリスト生成 | 次アクションを確定するためのチェックリストを提供する | 1 | 必須 |
| F-006 | キャッシュ管理 | 解析結果をURL単位でキャッシュする | 1 | 必須 |
| F-007 | 信頼性担保 | 根拠表示、免責同意、原文リンク、更新日時を提供する | 1 | 必須 |
| F-008 | パーソナライズ | ユーザーの状況に応じて要約をカスタマイズする | 1 | 必須 |
| F-009 | 結果表示 | 生成された要約・チェックリストをユーザーに表示する | 1 | 必須 |
| F-010 | 漫画生成 | 中間表現からユーザー主人公の漫画を生成する | 2 | 推奨 |
| F-011 | 履歴管理 | 過去の解析結果を保存・参照する | 2 | 推奨 |
| F-012 | フィードバック | 生成結果の正確性に関するフィードバックを収集する | 2 | 推奨 |
| F-013 | ダウンロード | 生成結果をファイルとしてダウンロードする | 2 | 推奨 |
| F-014 | 共有機能 | 生成結果をSNS等で共有する | 3 | 任意 |
| F-015 | 音声読み上げ | 要約を音声で読み上げる | 3 | 任意 |
| F-016 | 多言語対応 | 複数言語での要約生成 | 3 | 任意 |

### 5.2 機能詳細（Phase 1）

#### F-001 URL入力機能

| 項目 | 内容 |
|------|------|
| 機能概要 | ユーザーが行政ページのURLを入力するインターフェースを提供する |
| 入力 | URL文字列 |
| 出力 | バリデーション結果、解析開始通知 |
| 処理内容 | URLの形式チェック、アクセス可否の確認、対応サイトの判定、キャッシュ有無の確認 |
| 制約事項 | 日本国内の行政サイト（.go.jp、.lg.jp等）を優先対応 |

#### F-002 ページ解析機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 指定されたURLからWebページのコンテンツを取得し、構造を解析する |
| 入力 | 検証済みURL |
| 出力 | 解析済みページデータ（テキスト、構造情報） |
| 処理内容 | HTMLの取得、不要要素の除去、本文抽出、セクション分割 |
| 制約事項 | JavaScriptレンダリングが必要なページへの対応は段階的に実施 |

#### F-003 中間表現生成機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 解析結果からLLMを用いて構造化された中間表現を生成する |
| 入力 | 解析済みページデータ |
| 出力 | 中間表現（JSON形式） |
| 処理内容 | 制度名・概要の抽出、対象者条件の特定、手続きフローの整理、必要書類の列挙、例外条件の抽出、根拠箇所のマッピング、パーソナライズ用質問の生成 |

**中間表現のデータ構造**：

```json
{
  "title": "制度名",
  "summary": "制度の概要（1-2文）",
  "target": {
    "conditions": ["対象条件1", "対象条件2"],
    "exceptions": ["例外条件1"]
  },
  "procedure": {
    "steps": [
      {"order": 1, "action": "手続き1", "details": "詳細"},
      {"order": 2, "action": "手続き2", "details": "詳細"}
    ],
    "required_documents": ["書類1", "書類2"],
    "deadline": "期限情報",
    "contact": "問い合わせ先"
  },
  "benefits": {
    "description": "給付・支援内容",
    "amount": "金額等（該当する場合）"
  },
  "sources": [
    {"section": "セクション名", "original_text": "根拠となる原文", "source_id": "src-001"}
  ],
  "personalization": {
    "questions": [
      {
        "id": "q1",
        "question": "お子さんの年齢は？",
        "type": "select",
        "options": ["0-2歳", "3-5歳", "6-14歳", "15歳以上"],
        "affects": ["target.conditions", "benefits.amount"]
      }
    ]
  },
  "metadata": {
    "source_url": "元のURL",
    "fetched_at": "取得日時",
    "cache_expires_at": "キャッシュ有効期限"
  }
}
```

#### F-004 要約生成機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 中間表現から平易な言葉で書かれた要約ドキュメントを生成する |
| 入力 | 中間表現（JSON）、パーソナライズ回答（任意） |
| 出力 | 要約ドキュメント（Markdown形式） |
| 処理内容 | 専門用語の平易化、文章の簡潔化、重要ポイントの強調、根拠リンクの付与、パーソナライズ適用 |
| 品質基準 | 中学生でも理解できる日本語レベル、原文の正確性を維持、各文に根拠を紐付け |

#### F-005 チェックリスト生成機能

| 項目 | 内容 |
|------|------|
| 機能概要 | ユーザーが次に取るべきアクションを確認できるチェックリストを生成する |
| 入力 | 中間表現（JSON）、パーソナライズ回答（任意） |
| 出力 | インタラクティブなチェックリスト |
| 処理内容 | 必要な手続きのリスト化、期限の明示、必要書類の一覧化、優先順位付け |

#### F-006 キャッシュ管理機能

| 項目 | 内容 |
|------|------|
| 機能概要 | URL単位で解析結果をキャッシュし、重複処理を削減する |
| 入力 | URL、解析結果 |
| 出力 | キャッシュ済みデータまたはキャッシュミス通知 |
| 処理内容 | URLのハッシュ化、キャッシュ保存・取得、有効期限管理 |
| キャッシュ期間 | 24〜72時間（コンテンツの更新頻度に応じて調整） |
| 無効化条件 | 元ページの更新検知、手動無効化、期限切れ |

#### F-007 信頼性担保機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 生成された情報の信頼性を担保するための各種機能を提供する |

**サブ機能一覧**：

| サブ機能 | 説明 |
|---------|------|
| 根拠表示 | 要約の各文に「この情報の根拠」リンクを付与。クリックで原文該当箇所をハイライト表示 |
| 更新日時表示 | 「この情報は YYYY/MM/DD 時点のものです」を明示 |
| 免責同意 | 初回利用時に「本サービスは参考情報を提供するものであり、正確性を保証するものではありません。正式な手続きの際は必ず公式情報をご確認ください」への同意を取得 |
| 原文リンク | 常に元の行政ページへのリンクを目立つ位置に配置 |
| フィードバック | 「この情報は正しいですか？」ボタンを設置し、ユーザーからの報告を収集 |

#### F-008 パーソナライズ機能

| 項目 | 内容 |
|------|------|
| 機能概要 | ユーザーの状況に応じて要約内容をカスタマイズする |
| 入力 | 中間表現から生成された質問、ユーザーの回答 |
| 出力 | パーソナライズされた要約・チェックリスト |
| 処理内容 | 該当しない条件のフィルタリング、自治体固有情報の補足、状況に応じた手続きの分岐 |

**パーソナライズ質問の例**：

| 制度 | 質問例 | 効果 |
|------|-------|------|
| 児童手当 | お子さんの年齢は？ | 該当しない年齢条件をフィルタ |
| 児童手当 | お住まいの自治体は？ | 自治体固有の情報を補足 |
| 児童手当 | 現在受給中ですか？ | 新規申請 or 変更届を判別 |
| 介護保険 | 要介護認定は受けていますか？ | 認定申請 or サービス利用手続きを判別 |
| 転入届 | 前住所はどちらですか？ | 同一市内転居 or 他市町村からの転入を判別 |

### 5.3 機能詳細（Phase 2）

#### F-010 漫画生成機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 中間表現からユーザーを主人公とした漫画形式のコンテンツを生成する |
| 入力 | 中間表現（JSON）、ユーザー設定（任意） |
| 出力 | 漫画画像（複数コマ）またはWebコミック形式（Cloud Storageに保存し参照URLを返却） |
| 処理内容 | シナリオ生成、テンプレート選択、セリフ・ナレーション配置、画像合成、Cloud Storageへ保存 |
| 品質基準 | 4〜8コマ程度で制度の要点を伝達、視認性の高いデザイン |
| 生成方式 | テンプレート方式（キャラクター・背景は固定、セリフを動的生成）を採用しコスト削減 |
| トリガー | 「もっとわかりやすく」ボタンからのオンデマンド生成 |
| 非同期処理 | 生成完了までポーリングまたはプッシュ通知で状態を通知 |

#### F-011 履歴管理機能

| 項目 | 内容 |
|------|------|
| 機能概要 | ユーザーが過去に閲覧した解析結果を保存・参照できる |
| 入力 | ユーザー識別子、解析結果ID |
| 出力 | 履歴一覧、過去の解析結果 |
| 処理内容 | ローカルストレージまたはサーバーサイドでの履歴保存、一覧表示、再閲覧 |
| 保存期間 | 90日間 |

#### F-012 フィードバック機能

| 項目 | 内容 |
|------|------|
| 機能概要 | 生成結果の正確性に関するユーザーフィードバックを収集・分析する |
| 入力 | ユーザーの評価（正確/不正確）、詳細コメント（任意） |
| 出力 | フィードバックレポート、改善対象の特定 |
| 処理内容 | フィードバック収集、集計、問題箇所の特定、プロンプト改善への反映 |

---

## 6. 非機能要件

### 6.1 性能要件

| 項目 | 要件 |
|------|------|
| 応答時間（キャッシュヒット時） | 1秒以内 |
| 応答時間（URL解析・新規） | 10秒以内 |
| 応答時間（要約生成） | 15秒以内 |
| 応答時間（漫画生成） | 60秒以内（非同期、Phase 2） |
| 同時接続数 | 100ユーザー以上 |
| 可用性 | 99.5%以上（月間） |
| キャッシュヒット率目標 | 70%以上 |

### 6.2 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 通信暗号化 | HTTPS必須 |
| 入力検証 | URLインジェクション対策、XSS対策 |
| APIキー管理 | 環境変数での管理、ログへの出力禁止 |
| 個人情報 | ユーザーの入力URL・パーソナライズ回答は一定期間後に削除 |
| 免責同意 | 初回利用時の同意取得と記録 |

### 6.3 ユーザビリティ要件

| 項目 | 要件 |
|------|------|
| 対応デバイス | PC（Chrome, Firefox, Safari, Edge）、スマートフォン（iOS, Android） |
| レスポンシブ対応 | 必須 |
| アクセシビリティ | WCAG 2.1 Level AA準拠を目標 |
| 言語 | 日本語（Phase 3で多言語対応） |
| 文字サイズ | 第1優先ユーザー向けに大きめのデフォルトサイズ（18px）、調整可能 |
| カラーコントラスト | WCAG AA基準（4.5:1以上） |

### 6.4 運用・保守要件

| 項目 | 要件 |
|------|------|
| ログ管理 | アクセスログ、エラーログの保存（90日間） |
| 監視 | サーバー死活監視、エラー率監視、キャッシュヒット率監視 |
| バックアップ | 日次バックアップ |
| アップデート | LLMモデル更新、プロンプト改善を定期的に実施 |
| フィードバック対応 | 週次でフィードバックを確認し、問題があれば対応 |

---

## 7. システム構成

### 7.0 推奨構成サマリ（Google Cloud ベストプラクティス）

- ホスティング: Cloud Run（fully managed、リージョン固定、min/max instances 設定）
- エッジ: HTTPS Load Balancer + Cloud Armor（WAF/レート制限）
- バックエンド: Next.js Route Handlers（`/api/analyze`）
- LLM: Vertex AI（Gemini 2.5 Flash）
- キャッシュ: Memorystore（Redis）+ TTL（24〜72h）、SWR（stale-while-revalidate）
- データベース: Firestore（Phase 2 以降で履歴・フィードバック用途）
- 画像ストレージ: Cloud Storage（漫画画像の保存、Phase 2）
- 認証/認可: 公開運用時は Cloud Armor のレート制限＋必要に応じ Identity Platform/IAP
- 免責同意: ブラウザ localStorage（現状維持、将来は同意ログを Firestore に保存可）
- パーソナライズ: 質問生成・適用を API で実装（Phase 1 の必須化に合わせ拡張）
- シークレット管理: Secret Manager（APIキー/設定）
- CI/CD: Cloud Build（トリガー）→ Artifact Registry → Cloud Run（自動デプロイ）
- 監視/運用: Cloud Logging / Monitoring / Error Reporting / Trace

### 7.1 技術スタック（推奨）

| レイヤー | 採用技術 | 選定理由 |
|----------|----------|----------|
| フロントエンド | Next.js (App Router) | SSR/SSG対応、React エコシステムの活用 |
| バックエンド | Next.js Route Handlers | フロントエンドと統合管理、Cloud Run で実行 |
| エッジ/セキュリティ | HTTPS Load Balancer + Cloud Armor | グローバルTLS終端、WAF/レート制限 |
| LLM | Vertex AI (Gemini 2.5 Flash) | 日本語対応と安定運用、GCP 統合 |
| 画像生成 | 未実装（Phase 2） | 低コスト・安定品質のためテンプレート方式を予定 |
| キャッシュ | Memorystore (Redis) | スケールアウト時の共有キャッシュ、TTL管理 |
| データベース | Firestore（Phase 2） | 履歴/フィードバックの低運用DB |
| ホスティング | Cloud Run | オートスケール、ゼロ運用、コンテナ実行 |
| CI/CD | Cloud Build + Artifact Registry + Cloud Run | 安全なイメージ管理と自動デプロイ |
| 秘密情報 | Secret Manager | キーの安全管理とローテーション |
| 監視 | Cloud Logging / Monitoring / Trace / Error Reporting | 監視・可観測性の標準構成 |
| 状態管理 | Zustand / Jotai | 軽量で Next.js との相性が良い |
| スタイリング | Tailwind CSS | ユーティリティファースト、高速な開発 |

### 7.2 アーキテクチャ概要（推奨）

```
┌─────────────────────────────────────────────────────────────────┐
│                HTTPS Load Balancer + Cloud Armor               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Cloud Run                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Next.js App                            │  │
│  │  ┌─────────────────┐    ┌─────────────────────────────┐   │  │
│  │  │   App Router    │    │   Route Handlers            │   │  │
│  │  │   (Frontend)    │◄──►│   /api/analyze              │   │  │
│  │  └─────────────────┘    └──────────┬──────────────────┘   │  │
│  │                Redis Cache（Memorystore）                  │  │
│  └───────────────────────────────────┼───────────────────────┘  │
└──────────────────────────────────────┼──────────────────────────┘
               │                       │
        ┌──────┴───────┐        ┌──────┴────────┐
        │              │        │               │
        ▼              ▼        ▼               ▼
  ┌─────────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐
  │ Vertex AI   │  │ Secret   │  │ Cloud    │  │ 行政サイト   │
  │ (Gemini)    │  │ Manager  │  │ Logging  │  │ (スクレイピング)|
  └─────────────┘  └──────────┘  └──────────┘  └─────────────┘

  [Phase 2]
  Cloud Tasks / Pub/Sub → Cloud Run Jobs（漫画生成）
```

### 7.3 キャッシュ戦略（推奨）

```
┌─────────────────────────────────────────────────────────────────┐
│                    キャッシュフロー                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [URLリクエスト]                                                │
│        │                                                        │
│        ▼                                                        │
│  ┌─────────────┐    YES    ┌─────────────────────────┐         │
│  │Redisに有?   │─────────►│即座に結果返却（<1秒）    │         │
│  └─────────────┘           └─────────────────────────┘         │
│        │ NO                                                     │
│        ▼                                                        │
│  ┌─────────────────────────────────────────────┐               │
│  │新規解析処理                                  │               │
│  │  1. ページ取得・解析                        │               │
│  │  2. 中間表現生成（Vertex AI）               │               │
│  │  3. 要約・チェックリスト生成                │               │
│  │  4. Redisに保存（TTL: 24〜72h）             │               │
│  │  5. ユーザーに結果返却                      │               │
│  └─────────────────────────────────────────────┘               │
│                                                                 │
│  [SWR: stale-while-revalidate]                                  │
│  - TTL切れ直前は古い結果を返しつつ非同期更新                    │
│  - 失敗時は旧結果を維持し、エラーをログ/メトリクス化            │
│                                                                 │
│  [無効化条件]                                                    │
│  - TTL期限切れ                                                    │
│  - 元ページの更新検知（Last-Modified/ETag）                      │
│  - 手動パージ（管理コマンド）                                    │
│                                                                 │
│  [漫画生成リクエスト（Phase 2）]                                │
│        │                                                        │
│        ▼                                                        │
│  ┌─────────────────────────────────────────────┐               │
│  │非同期生成                                    │               │
│  │  1. Cloud Tasks / Pub/Sub に追加            │
│  │  2. 即座にジョブIDを返却                    │
│  │  3. Cloud Run Jobs で生成                  │
│  │  4. 完了後、ポーリングで通知               │
│  └─────────────────────────────────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.4 Next.js プロジェクト構成（現状）

```
komanabi/
├── src/
│   ├── app/
│   │   ├── page.tsx                 # トップページ（URL入力）
│   │   ├── result/
│   │   │   └── page.tsx             # 結果表示
│   │   ├── api/
│   │   │   └── analyze/
│   │   │       └── route.ts         # URL解析API
│   │   └── layout.tsx
│   ├── components/
│   │   ├── UrlInput.tsx
│   │   ├── SummaryViewer.tsx
│   │   ├── SourceReference.tsx     # 根拠表示コンポーネント
│   │   ├── ChecklistViewer.tsx
│   │   ├── DisclaimerBanner.tsx    # 免責表示
│   │   └── DisclaimerModal.tsx     # 免責同意
│   ├── lib/
│   │   ├── gemini.ts               # Vertex AI クライアント
│   │   ├── scraper.ts              # Webスクレイピング
│   │   ├── mocks/
│   │   │   └── sampleData.ts
│   │   └── types/
│   │       └── intermediate.ts     # 中間表現の型定義
│   └── stores/
│       └── analyzeStore.ts
└── ...
```

### 7.5 外部連携

| 連携先 | 用途 | 連携方式 | Phase |
|--------|------|----------|-------|
| 行政Webサイト | コンテンツ取得 | HTTP/HTTPS（cheerio / Playwright） | 1 |
| Vertex AI (Gemini) | 文書解析・中間表現生成・要約生成 | SDK/REST | 1 |
| nanobanana | 漫画画像生成 | REST API | 2（未実装） |

### 7.6 Cloud Run デプロイ設定（現状）

| 項目 | 設定内容 |
|------|----------|
| ビルド | Cloud Build（Dockerfile） |
| 実行環境 | Cloud Run（コンテナ、PORT=8080） |
| Node.js Version | 20.x（Dockerベース） |
| 認証 | 未導入（公開URL） |
| 環境変数 | なし（Vertex AI はアプリケーション既定認証） |
| リージョン | asia-northeast1 |
| 実行サービスアカウント | 30981781876-compute@developer.gserviceaccount.com（デフォルト） |
| 実行権限 | roles/editor（Vertex AI 含むAPIアクセス権） |

---

## 8. 画面設計（概要）

### 8.1 画面一覧

| 画面ID | 画面名 | 概要 | Phase |
|--------|--------|------|-------|
| SCR-001 | トップページ | URL入力、サービス説明、免責事項 | 1 |
| SCR-002 | 免責同意画面 | 初回利用時の同意取得 | 1 |
| SCR-003 | パーソナライズ質問画面 | ユーザー状況の入力（スキップ可） | 1 |
| SCR-004 | 解析中画面 | 進捗表示、待機アニメーション | 1 |
| SCR-005 | 結果表示画面 | 要約・チェックリスト・根拠の表示 | 1 |
| SCR-006 | 根拠詳細モーダル | 原文該当箇所のハイライト表示 | 1 |
| SCR-007 | 漫画ビューア | 漫画のコマ送り表示 | 2 |
| SCR-008 | 履歴画面 | 過去の解析結果一覧 | 2 |

### 8.2 画面遷移

```
[トップページ] → [免責同意画面]（初回のみ）
       │
       ▼
[パーソナライズ質問画面]（スキップ可）
       │
       ▼
[解析中画面] → [結果表示画面]
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
[根拠詳細モーダル] [漫画ビューア] [履歴画面]
                   （Phase 2）    （Phase 2）
```

### 8.3 主要画面のワイヤーフレーム概要

#### SCR-005 結果表示画面

```
┌─────────────────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ⚠️ この情報は 2025/01/10 時点のものです                   │ │
│ │    正式な手続きは必ず公式サイトをご確認ください           │ │
│ │    [公式サイトを開く →]                                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ # 児童手当のご案内                                          │
│                                                             │
│ ## あなたの場合                                             │
│ パーソナライズ結果に基づくサマリー                          │
│                                                             │
│ ## この制度について                                         │
│ 要約テキスト [根拠1] 要約テキスト [根拠2]                   │
│                                                             │
│ ## もらえる金額                                             │
│ • 0〜2歳：月15,000円 [根拠3]                                │
│ • 3歳〜中学生：月10,000円 [根拠3]                           │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ✅ やることチェックリスト                                 │ │
│ │ □ 申請書を記入する                                       │ │
│ │ □ 必要書類を準備する（健康保険証、通帳コピー）           │ │
│ │ □ 市役所子ども課に提出する（期限：出生から15日以内）     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [📖 もっとわかりやすく（漫画で見る）]  ← Phase 2で実装      │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ この情報は正しいですか？  [👍 はい] [👎 いいえ]          │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. データ設計（概要）

### 9.1 主要エンティティ

| エンティティ | 説明 | 主な属性 |
|--------------|------|----------|
| Request | 解析リクエスト | ID, URL, URLハッシュ, 作成日時, ステータス |
| IntermediateData | 中間表現 | ID, RequestID, JSONデータ, 作成日時 |
| Summary | 要約データ | ID, RequestID, Markdownテキスト, パーソナライズ条件 |
| Checklist | チェックリスト | ID, RequestID, 項目リスト |
| Manga | 漫画データ（Phase 2） | ID, RequestID, 画像URL群, Cloud Storage オブジェクトパス, メタデータ |
| Cache | キャッシュ管理 | URLハッシュ, IntermediateDataID, 有効期限 |
| Feedback | フィードバック | ID, RequestID, 評価, コメント, 作成日時 |
| Consent | 免責同意記録 | ユーザー識別子, 同意日時, バージョン |

### 9.2 キャッシュキー設計

```
キー形式: komanavi:cache:{URLのSHA256ハッシュ}
値: {
  intermediateData: {...},
  createdAt: "ISO8601日時",
  expiresAt: "ISO8601日時",
  sourceLastModified: "元ページの最終更新日（取得可能な場合）"
}
TTL: 24〜72時間（コンテンツタイプに応じて設定）
```

---

## 10. 制約事項・前提条件

### 10.1 制約事項

- 行政サイトの構造変更により、解析精度が低下する可能性がある
- LLMの出力は確率的であり、同一入力でも結果が異なる場合がある
- 漫画生成の品質は画像生成AIの性能に依存する（Phase 2）
- 著作権・利用規約の観点から、元サイトのコンテンツを大量にキャッシュすることは避ける
- 本サービスは参考情報の提供を目的とし、正式な行政手続きの代替とはならない

### 10.2 前提条件

- ユーザーはインターネット接続環境を有すること
- 対象とする行政サイトはHTTP/HTTPSでアクセス可能であること
- Vertex AI（Gemini）の利用契約が締結されていること
- nanobanana API の利用契約が締結されていること（Phase 2）
- Google Cloud プロジェクト（Cloud Run/Vertex AI/Secret Manager 等）が準備されていること
- ユーザーは初回利用時に免責事項に同意すること

---

## 11. リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Vertex AI (Gemini) の応答遅延・障害 | 高 | 中 | タイムアウト設定、リトライ機構、ストリーミングレスポンスの活用、キャッシュによる負荷軽減 |
| nanobanana API の応答遅延・障害 | 中 | 中 | 非同期処理、フォールバック画像の用意、テンプレート方式による代替 |
| 行政サイトの構造変更 | 中 | 高 | 汎用的な解析ロジック、定期的な動作確認、LLMによる柔軟な抽出 |
| 生成内容の誤り | 高 | 中 | 根拠箇所の明示、免責事項の表示、フィードバック機能、原文リンクの常時表示 |
| 画像生成の品質不安定 | 中 | 中 | テンプレート方式の優先採用、プロンプトの最適化 |
| Cloud Run リクエストタイムアウト | 中 | 中 | タイムアウト設定の最適化、漫画生成は非同期処理化 |
| API利用コストの超過 | 中 | 中 | 利用量監視、キャッシュ活用（目標ヒット率70%）、レート制限 |
| 法的リスク（誤情報による被害） | 高 | 低 | 免責同意の取得、根拠の明示、「参考情報」であることの強調 |

---

## 12. コスト試算

### 12.1 月間コスト試算（月間1万リクエスト想定）

| 項目 | 単価 | キャッシュなし | キャッシュあり（70%ヒット） |
|------|------|---------------|---------------------------|
| Vertex AI（中間表現＋要約） | ¥10/リクエスト | ¥100,000 | ¥30,000 |
| 画像生成（Phase 2、4-8コマ） | ¥30/リクエスト | ¥300,000 | ¥90,000（オンデマンドのため50%利用想定で¥45,000） |
| Cloud Run（運用費） | - | ¥2,500 | ¥2,500 |
| Memorystore（Redis） | - | - | ¥3,000 |
| Firestore（Phase 2） | - | ¥2,000 | ¥2,000 |
| **合計（Phase 1）** | - | ¥104,500 | **¥37,500** |
| **合計（Phase 2含む）** | - | ¥404,500 | **¥82,500** |

**コスト削減効果**：キャッシュ導入により約64%のコスト削減を見込む

---

## 13. 今後の検討事項

1. **ユーザー認証機能**：履歴保存のためのアカウント機能の要否
2. **プッシュ通知**：漫画生成完了時の通知手段（Web Push、メール等）
3. **行政機関との連携**：オープンデータの活用、公式APIの提供依頼
4. **オフライン対応**：PWA化による閲覧済み情報のオフラインアクセス
5. **AI精度の継続改善**：フィードバックを活用したプロンプト改善サイクルの確立
6. **行政機関向け管理画面**：行政機関が自らコンテンツを登録・管理できる機能

---

## 14. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| プロジェクトオーナー | | | |
| プロジェクトマネージャー | | | |
| 開発リーダー | | | |

---

*本要件定義書は、プロジェクトの進行に伴い更新される可能性があります。*