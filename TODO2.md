# KOMANAVI Phase 2 TODO

## 目的
Phase 2（拡張機能）の実装に向けたタスク整理。

---

## Step 1: 企画・要件整理

### 1.1 Phase 2 スコープ確定
- [x] 漫画生成の要件（4〜8コマ、テンプレート方式、品質基準）を確定
	- 4〜8コマ、テンプレート方式（固定キャラ/背景＋セリフ差し替え）
	- 1コマ1メッセージ。文字サイズは16px相当以上、スマホ幅でも可読
	- 出力: PNG、最長辺1200px、背景コントラストを確保
	- 生成失敗時はテキスト要約にフォールバック
- [x] 履歴管理の保存方式（ローカル or サーバー）を確定
	- Phase 2 はローカルストレージ保存（サーバー側は未保存）
	- 保存期間: 90日（クライアント側で期限超過分を削除）
- [x] フィードバック収集の入力項目と保存範囲を確定
	- 入力項目: 評価（正確/不正確）、コメント任意、対象URL、生成ID、日時
	- 保存範囲: Phase 2 はローカル保存のみ（送信APIは Phase 2.3 で設計）
- [x] パーソナライズ拡充の対象ユースケースを確定
	- 優先ユースケース: 児童手当/子育て給付、転入届、介護保険
	- 質問例: 子どもの年齢、自治体、現受給/認定有無、前住所

### 1.2 非機能・運用要件
- [x] 漫画生成の非同期フロー（ジョブID・ポーリング/通知）を定義
	- API: POST /api/manga → { jobId }
	- Status API: GET /api/manga/{jobId} → { status: queued|processing|done|error, progress?, result?, error? }
	- ポーリング: 2s間隔（最大60s）、doneで停止／errorでフォールバック
	- 通知: Phase 2 はポーリングのみ（プッシュ通知はPhase 3検討）
	- 失敗時: テキスト要約へフォールバック＋再試行ボタン表示
- [x] 生成コスト上限・レート制限方針を決定
	- 生成上限: 1ユーザーあたり 1日3回まで（localStorageで回数管理）
	- クールダウン: 同一URLは10分以内の再生成を禁止
	- 同時生成: 1ジョブ/ユーザー（既存ジョブがprocessingなら新規拒否）
	- コスト監視: 日次/週次の生成数を集計（Phase 2はローカル集計のみ）
- [x] 監視項目（生成成功率・待機時間）を定義
	- 成功率: done/(done+error)
	- 待機時間: queued→done の95パーセンタイル
	- エラー種別: timeout / api_error / validation_error / unknown
	- 目標値: 成功率95%以上、P95待機時間60秒以内

---

## Step 2: バックエンド拡張

### 2.1 漫画生成 API（Phase 2）
- [x] 漫画生成 API の設計（POST /api/manga, GET /api/manga/{jobId}）
- [x] 漫画生成ジョブ管理（状態: queued/processing/done/error）
- [x] 生成結果の保存形式（画像URL群・メタデータ）
- [x] エラーハンドリング（timeout / api_error / validation_error / unknown）
- [x] 生成失敗時のフォールバック仕様（テキスト要約）
- [x] レート制限・クールダウン・同時生成制限

### 2.2 履歴管理
- [x] 履歴保存の方式決定（ローカルストレージ）
- [ ] 履歴一覧取得（ローカル、ページング相当）
- [ ] 履歴詳細取得（ローカル）
- [ ] 保存期間（90日）に合わせた削除処理

---

## Step 3: フロントエンド拡張

### 3.1 漫画ビューア
- [ ] 漫画ビューア画面の作成（SCR-007）
- [ ] コマ送り UI（次/前、ページインジケータ）
- [ ] 生成中/失敗時の表示
- [ ] 「もっとわかりやすく」ボタンからの起動

### 3.2 履歴画面
- [ ] 履歴一覧画面（SCR-008）
- [ ] 解析結果への再遷移
- [ ] 履歴削除 UI（任意）

### 3.3 フィードバック UI
- [ ] 「この情報は正しいですか？」ボタンの実装
- [ ] コメント入力（任意）
- [ ] 送信完了/失敗のフィードバック

### 3.4 パーソナライズ拡充
- [ ] 質問UIの追加と回答保存
- [ ] パーソナライズ適用の表示改善

### 3.5 ダウンロード（Phase 2）
- [ ] 生成結果のダウンロード導線（要約/漫画）

---

## Step 4: インフラ・運用準備

### 4.1 データストア
- [ ] （将来）履歴/フィードバック保存先の構築（Firestore等）
- [ ] （漫画）画像ストレージ設定（Cloud Storage、Phase 2）
- [ ] 環境変数の追加（ストレージ/APIキー）

### 4.2 監視・ログ
- [ ] 漫画生成のジョブ監視
- [ ] 失敗率・遅延の可視化

---

## Step 5: テスト・動作確認

- [ ] 漫画生成のE2E動作確認
- [ ] 履歴保存・一覧・再表示の動作確認
- [ ] フィードバック送信・保存確認
- [ ] モバイル表示確認（Phase 2）

---

## 参考: Phase 2 スコープ（要件定義書）
- 漫画生成（テンプレート方式、オンデマンド）
- 履歴管理
- フィードバック収集
- パーソナライズ拡充
