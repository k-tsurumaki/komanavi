---
title: "【KOMANAVI】行政情報をやさしく届けて、支援が必要な人の「次の一歩」をつくる"
emoji: "📖"
type: "idea"
topics: ["gch4", "googlecloud", "vertexai", "gemini", "cloudrun", "nextjs"]
published: false
---

## はじめに

> 制度は「ある」のに、助けが届かない。

試しに、お住まいの自治体の **「児童手当」のページ** を開いてみてください。

- 所得制限の計算式
- 「扶養親族等の数」による場合分け
- 「〇〇法第△条に規定する…」という但し書き

**正確な情報が書かれているのに、「自分が対象なのか」にたどり着く前に読む気を失う。**

私自身、引っ越し手続きを調べていて、複数タブを開いては閉じ、結局「窓口で聞いたほうが早い」と諦めました。ITに慣れた自分ですらそうなら——**子育て世帯、高齢者、外国人住民、災害被災者にとって、このハードルはどれほど高いのか。**

この **"入口での断念"** を減らすために作ったのが、**行政ページのURLを貼るだけ** で「やさしい要約」「チェックリスト」「漫画」を自動生成するWebアプリ **KOMANAVI（コマナビ）** です。


## 🔍 背景：「正しいのに、届かない」構造

### ある「子育て世帯」の体験

想像してみてください。子どもが生まれたばかりの親が、「どんな支援を受けられるのか」を調べようとする場面を。

1. 市の公式サイトを開く
2. 「児童手当」「児童扶養手当」「乳幼児医療費助成」——似た名前の制度が複数ヒットする
3. あるページを開くと、所得制限の計算式、「扶養親族等の数」による場合分け、「〇〇法第△条に規定する…」という但し書き
4. 3つ目のタブを開いた時点で、**「自分が対象なのか」すら分からないまま、ブラウザを閉じる**

これは架空のシナリオではありません。行政情報は「正確であること」が最優先で設計されており、その正確性こそが **読まれない原因** になっているのです。

### 行政負担（Administrative Burden）の3つのコスト

公共政策研究では、住民が行政と接点を持つ際の負担を **3つのコスト** で整理しています。

| コスト | 意味 | 行政ページでの典型例 |
|--------|------|-----|
| **Learning（学習）** | 制度を知り、理解する負担 | 長文・専門用語・分散した情報。「自分が対象か」の判断に到達できない |
| **Psychological（心理）** | 不安やスティグマ | 「読んでも分からない自分が悪い」という自責。窓口に行くこと自体の心理障壁 |
| **Compliance（手続）** | 実際の申請・提出の手間 | 書類集め・窓口訪問・平日のみの受付 |

KOMANAVIが解くのは、このうち **Learning（学習）コスト** と **Psychological（心理）コスト** ——つまり「理解の入口」の障壁です。

> 参考：[Administrative Burden: Learning, Psychological, and Compliance Costs in Citizen-State Interactions](https://academic.oup.com/jpart/article-abstract/25/1/43/88595)

### データで見る「入口の詰まり」

この問題は体感だけでなく、データとしても観測されています。

#### 📊 相談件数：年間30万件超

厚生労働省の速報値によると、生活困窮者自立支援制度の新規相談は令和6年度で **302,670件**。

- 制度の入口で「相談する」という行為自体が巨大なボリュームになっている
- つまり **30万人が「ページを読んでも分からなかった」から窓口に来ている** 可能性がある

> 参考：[生活困窮者自立支援制度における新規相談件数等速報値](https://www.mhlw.go.jp/content/001612625.pdf)

#### 🏢 窓口DXでも課題認識

デジタル庁の「自治体窓口DX」資料でも、住民側の詰まりが明示されています。

- 「必要な申請や書類が分からない」
- 「どの窓口に行くべきか分からない」

> 参考：[自治体窓口DXSaaS概要説明資料](https://www.digital.go.jp/assets/contents/node/information/field_ref_resources/368bf896-1fe4-4c53-bccb-3167cd06eac8/38a6efd9/20251024_news_dxsaas_provide-public-offering_outline_05.pdf)



## ❓ 課題定義：「正確だが、使われない」——なぜ既存のアプローチでは解けないのか

行政ページは **「正確性」** を重視して設計されています。一方で、利用者は短時間で次の2点に到達できません。

1. **自分が対象か**（判断）
2. **次に何をすべきか**（行動）

:::message alert
正しいことは書いてある。しかし、文字量が多く、言い回しが難しく、情報が分散しているために、**読まれず使われない**——これが中核課題です。
:::

### 既存アプローチの限界

| 既存アプローチ | なぜ解けないか |
|--------------|--------------|
| **人手でページを書き直す** | 制度改定のたびに再編集が必要。正確性の責任が重く、改善スピードが出ない |
| **ChatGPT等に聞く** | 「何を聞けばいいか」が分からない人は、プロンプトを書くこと自体がハードル |
| **AIで要約だけ出す** | 「ふーん」で終わる。**自分が対象か・次に何をすべきか** に到達できない |



## 💡 KOMANAVI：行政情報の「理解の入口」

KOMANAVIは、前章で挙げた3つの限界すべてに対する回答として設計しました。

| 既存の限界 | KOMANAVIの回答 |
|-----------|--------------|
| 人手で書き直す → 改定に追随できない | **人手不要** — AIがリアルタイムに解析。制度改定にも自動追随 |
| ChatGPT等 → プロンプトが書けない | **質問不要** — URLを貼るだけ。プロンプトを考える必要がない |
| AI要約だけ → 「ふーん」で終わる | **要約で終わらない** — 意図入力→漫画 / 回答 / チェックリストまで一気通貫 |

### なぜ「漫画」なのか

「行政情報に漫画？」と思われるかもしれません。しかし、これは学術的な根拠に基づいた設計判断です。

| 課題 | 漫画の効果 | 理論・エビデンス |
|------|-----------|----------------|
| **読むのが大変**（学習コスト） | 視覚＋文章の二重チャネルで理解・記憶を支援 | [Dual-Coding Theory](https://www.sciencedirect.com/topics/neuroscience/dual-coding-theory) |
| **不安で読めない**（心理コスト） | 漫画的説明が理解を高め不安を低減 | [Randomized Trial](https://pubmed.ncbi.nlm.nih.gov/30959523/) |
| **自分ごとにならない** | 「自分が主人公」のパーソナライズ漫画 | KOMANAVIの独自設計 |

行政負担の3コストのうち、Learning と Psychological を漫画で同時に下げる——これがKOMANAVIの仮説です。



## 🚀 プロダクト詳細

### 7ステップのガイドフロー

行政情報の理解を「流れ」として設計しました。KOMANAVIでは、利用の流れを **7ステップ** に分解し、進捗インジケーターで「今どこにいて、次に何をすればいいか」を常に表示します。

| # | ステップ | 内容 | 対応する行政負担コスト |
|---|---------|------|------|
| 1 | **URLを解析** | 行政ページのURLを入力し、AIが取得・解析 | — |
| 2 | **要点を確認** | 構造化されたページ概要を確認 | Learning ↓ |
| 3 | **深掘りする**（任意） | チャット形式で気になるトピックを掘り下げ | Learning ↓ |
| 4 | **意図を入力** | 「実現したいこと」を一文で入力 | — |
| 5 | **漫画で確認** | 4〜8コマの漫画で直感的に理解 | Learning ↓ Psychological ↓ |
| 6 | **あなた向けの回答を作成** | パーソナライズされた回答を生成 | Learning ↓ Psychological ↓ |
| 7 | **チェックリストを確認** | 次に取るべきアクションを確認 | Compliance ↓ |



### 機能 1：ページ概要 —— 行政ページを1分で把握

AIがGoogle Search Groundingを活用してページ内容を取得し、以下の構造で概要を生成します。

| 表示項目 | 内容 |
|---------|------|
| 📌 **30秒で把握** | ページ全体の結論を1文で |
| 👤 **だれ向けの情報か** | 対象者の目安 |
| ✅ **実現できること** | 具体的な成果（最大3件） |
| ⚡ **最重要ポイント** | 制度利用に直結する事実を表形式で |
| ⚠️ **注意点** | 期限・例外条件など |
| 📞 **問い合わせ情報** | 電話番号・窓口・受付時間 |

すべての情報に **証跡URL（出典）** が紐づいており、AIの根拠を常に確認できます。



### 機能 ２：深掘りチャット ＆ 意図入力 —— 「自分ごと」に変換する

概要を確認した後、2つの方法でさらに深く知ることができます。

#### 💬 深掘りチャット

概要を読んで「ここ、もう少し詳しく知りたい」と思った箇所を、**ページを離れずにその場で掘り下げられる** チャット機能です。

#### 🎯 意図入力 —— ここがKOMANAVIの核心

「児童手当の申請方法が知りたい」のように、目的を一文で入力します。すると既存の情報を並べ替えるのではなく、**Google Search Groundingで意図に合った情報をWebから収集し直し**、最適化された回答を新たに生成します。

### 機能 ３：漫画で確認 —— 自分を主人公にして直感的に理解

Gemini 3.0 Pro Image が中間表現を読み取り、**4〜8コマの漫画** を自動生成します。

- **コマ構成はモデルが自律決定** — 何を・どの順で描くかをページの性質に応じて最適化
- **自分が主人公になる** — Myページのプロフィールで外見・性格をカスタマイズ
- **非同期生成** — 待っている間も要約やチェックリストを確認可能

「他人事」だった行政情報が、自分の姿で描かれることで **「自分ごと」** に変わる——心理コスト低減を狙った設計です。



### 機能 4：回答 & チェックリスト —— 「理解」を「行動」に変換する

#### 🎯 パーソナライズ回答（4ブロック構造）

意図入力をもとに生成される回答は、4ブロックに圧縮されます。

| ブロック | 内容 |
|---------|------|
| **結論** | 回答の要点を一文で即座に把握 |
| **あなたは対象になりそうですか？** | 該当可能性をYes/Noで判断 |
| **最優先の1手** | 最初にやるべきアクション |
| **見落とすと申請で困るポイント** | 期限切れ・書類不備などのリスクを事前警告 |

#### ✅ チェックリスト

意図入力と同時に、中間表現＋ユーザーの意図テキスト＋プロフィールから、次に取るべきアクションを **最大15項目・時系列順** で生成します。

- カテゴリ（書類準備・手続き・確認事項）と優先度を自動付与
- 重要項目は「重要」バッジで強調し、プログレスバーで完了率を可視化
- チェック状態は保存され、途中から再開可能



### 機能 5：Myページ —— すべての出力を「自分向け」に

プロフィール（年齢・職業・居住地・国籍・外見・性格など）を登録すると、**回答・チェックリスト・漫画のすべてが自動でパーソナライズ**されます。

- 例えば外国籍の方には在留カード関連の項目が追加され、漫画では登録した外見・性格が主人公に反映される
- **属性に応じて提示する情報の優先順位が変わる** ため、同じURLでもユーザーごとに異なる結果を返します



### 機能 6：信頼性の担保 —— AIを「鵜呑み」にさせない

AIが生成した情報から、いつでもワンクリックで一次情報（行政の原文ページ）にアクセスできる仕組みを組み込んでいます。

| 仕組み | 内容 |
|--------|------|
| **出典の明示** | すべての生成結果にGoogle Search Groundingの参照元URL・検索クエリを表示。根拠をワンクリックで確認可能。 |
| **免責事項** | 「参考情報であること」を明示するバナーとモーダル |





### 機能 7：会話履歴 —— 途中から再開できる

ログインユーザーの解析結果はCloud Firestoreに自動保存され、サイドバーからいつでも再参照できます。

- 概要・チェックリスト・意図回答・漫画を一括保存
- チェックリストの進捗も保持（途中から再開可能）
- ページ離脱時も `keepalive` 対応APIで確実に保存

行政手続きは「一度で完結しない」ことが多いため、**中断と再開を前提にした設計** です。



## 🏗️ アーキテクチャと技術的チャレンジ

### 全体構成

![architecture.md](../images/system_architecture.svg)

### 技術スタック

| カテゴリ | 技術 | 選定理由 |
|----------|------|----------|
| **フロントエンド** | Next.js 16 / React 19 / Tailwind CSS 4 | App Router + standalone出力でCloud Run最適化 |
| **状態管理** | Zustand 5 | 7ステップフローの複雑な状態を単一ストアで管理 |
| **AI SDK** | @google/genai（Vertex AI 経由） | Google Search Grounding対応 |
| **AI（解析）** | Gemini 3.0 Flash + Google Search Grounding | 低コスト＋Grounding Metadata取得 |
| **AI（漫画生成）** | Gemini 3.0 Pro Image | テキスト＋画像の同時生成 |
| **認証** | NextAuth v5 + Firebase Auth | Google認証＋Firestore連携 |
| **DB** | Cloud Firestore | スキーマレスで高速イテレーション |
| **ストレージ** | Cloud Storage | 署名付きURLで漫画画像を安全に配信 |
| **非同期処理** | Cloud Tasks + Cloud Run Worker | 漫画生成の長時間処理をオフロード |
| **CI/CD** | Cloud Build → Artifact Registry → Cloud Run | mainマージでasia-northeast1に自動デプロイ |


### Cloud Run によるゼロスケール構成

2つのCloud Runサービスで構成しています。

| サービス | 役割 | 構成 |
|---------|------|------|
| **komanavi** | Next.js（standalone） | フロントエンド兼APIサーバー |
| **komanavi-worker** | Express.js | 漫画生成専用（512Mi / タイムアウト600秒） |

- リクエストがないときはインスタンスを **0にスケールダウン** → PoCフェーズのコストを最小限に
- Cloud Buildによる自動デプロイと合わせて、**個人開発でも本番品質のインフラ** を維持

### データフロー —— 中間表現パイプライン

すべてのAI処理は単一のエンドポイント `/api/analyze` に統合され、`mode` パラメータで分岐します。その中核が **中間表現（Intermediate Representation）** です。

行政ページのドキュメントタイプ（給付制度・手続き案内・FAQなど **6種類**）を自動判定し、それぞれに最適化された構造化JSONを **1回だけ生成**。下流の要約・チェックリスト・漫画がすべてこの中間表現を共有します。

- **LLM呼び出しの最小化** — 同じURLを何度解析しても中間表現は1回（24時間TTLキャッシュ）
- **一貫性** — すべての出力が同じ事実セットを参照。情報のブレがない
- **拡張性** — 新しい出力形式を追加する際、中間表現から派生するだけ



### Google Search Grounding への全面移行

#### 課題：スクレイピングの限界

当初はCheerioによるHTMLスクレイピングで行政ページの内容を取得していました。しかし、開発を進めるうちに「これでは本質的に無理がある」と気づきます。

| 壁 | 具体的な状況 |
|-----|------------|
| **PDF問題** | 行政情報の多くがPDFで公開されている。HTMLスクレイピングでは中身を取得できない |
| **JSレンダリング** | SPAやiframe埋め込みのページが増加。Cheerioでは空のHTMLが返る |
| **文脈の欠落** | HTMLのタグ構造だけでは「この情報が何を意味するか」の文脈が失われる |
| **メンテナンスコスト** | 自治体ごとにHTML構造が異なり、パーサーの保守が膨大になる |

#### 解決策：「スクレイピングしない」という判断

発想を転換しました。**自分でページ情報を取得するのではなく、Gemini に取得してもらう**。

```typescript
const result = await ai.models.generateContent({
  model: 'gemini-3-flash-preview',
  contents: [{ role: 'user', parts: [{ text: prompt }] }],
  config: {
    temperature: 1.0,  // Google推奨値
    tools: [{ googleSearch: {} }],  // ← これだけ
  },
});
```

`tools: [{ googleSearch: {} }]` を指定するだけで、Geminiが自動的にWeb検索を実行し、ページ内容を取得します。PDFもJSレンダリングページも、Googleの検索インフラが解決してくれます。

さらに、レスポンスの `GroundingMetadata` から以下が自動的に取得できます：

- **searchEntryPoint**: 検索クエリのURLパラメータ
- **groundingChunks**: 参照されたWebページのURL
- **webSearchQueries**: 実際に実行された検索クエリ

これが **出典表示の基盤** になりました。スクレイピング時代には手動で管理していた「この情報はどこから来たか」が、Google Search Groundingでは **自動的に** 記録されるのです。



### 漫画生成の非同期パイプライン

#### 課題：漫画生成は重い

Gemini Pro Imageによる漫画生成は、1リクエストあたり **30秒〜2分** かかります。通常のAPIタイムアウト（30秒）では間に合いません。かといって、ユーザーを2分間待たせるわけにもいきません。

#### 解決策：Cloud Tasks + Worker + 進捗ポーリング

漫画生成を完全に非同期化し、メインアプリから切り離しました。

```
[メインアプリ]
  ↓ Firestoreにジョブ作成 + Cloud Tasksにエンキュー
[Cloud Tasks]
  ↓ OIDC認証付きHTTPリクエスト
[Cloud Run Worker (Express.js)]
  ↓ ドキュメントタイプに応じたパネル構成を決定
  ↓ Gemini Pro Image で生成（responseModalities: ['TEXT', 'IMAGE']）
  ↓ Cloud Storage にアップロード
  ↓ Firestore のジョブステータスを更新（30% → 50% → 70% → 85% → 100%）
[クライアント]
  ↓ 2秒間隔でポーリング → 署名付きURL（60分TTL）で画像を表示
```


### 設計で大切にしたこと

#### 「やさしい日本語」の徹底

すべてのAIプロンプトに以下の制約を組み込んでいます。

> 専門用語はそのまま残さず、必要なら言い換える（例：「受給資格」→「受け取れる条件」）

- **ターゲット**: 子育て世帯・高齢者の介護者・外国人住民・災害被災者
- **UI**: フォントサイズ18px以上・高コントラスト
- **プロンプト管理**: 7つすべて外部テンプレートとしてコードから分離。非エンジニアでもレビュー可能


## 🔮 今後の展望

### 多言語対応 —— 「やさしい日本語」から「やさしい多言語」へ

KOMANAVIの第1優先ターゲットには **外国人住民** が含まれています。

- 現在の「やさしい日本語」を起点に、英語・中国語・ベトナム語・ポルトガル語などへ展開予定
- 中間表現パイプラインの設計上、新しい出力言語は「翻訳タスク」を追加するだけで対応可能

### ユーザーテストの実施

現在のKOMANAVIは「作り手の仮説」に基づいて設計されています。

- 実際のターゲットユーザー（子育て支援団体、外国人支援NPOなど）にフィードバックを収集予定
- 「理解の入口」として本当に機能しているか——これはユーザーにしか検証できない


## おわりに

行政の情報は「正確に書かれている」ことがほとんどです。しかし、最も支援を必要とする人ほど、その正確な情報に到達できないまま断念している。

**制度はある。情報もある。でも、届かない。**

この構造的なギャップを、「人が頑張る」のではなく、**AIの力で埋められないか** ——それがKOMANAVIの出発点でした。

- **URLを貼るだけ** で「自分が対象か」「次に何をすべきか」がわかる
- 原文の出典が常に確認できる
- 漫画で直感的にイメージできる
- 自分が主人公だから、「自分ごと」として理解できる

KOMANAVIはまだPoCフェーズのプロダクトです。しかし、行政情報の「理解の入口」として、制度と人との距離を少しでも縮められる可能性を感じています。

**「正しいのに、届かない」を「正しくて、届く」に変える。** その一歩目として、KOMANAVIを世に出します。
