## 背景

制度は「ある」のに、助けが届かない瞬間があります。

行政の支援を求めて制度のWebページを開いた人が、長い前提条件と例外、分岐だらけの手続きに圧倒され、「自分は対象なのか」が最後まで確信できず、必要書類も期限も見えないままタブを閉じてしまう——この"断念"が、最も支援を必要とする層ほど繰り返し起きています。

ひとり親、高齢者の介護者、外国人住民、災害被災者——緊急性が高く情報弱者になりやすい人ほど、行政ページを「読んで、理解して、行動に移す」ハードルが高いのが実情です。

### 公共政策研究に基づいた分析

公共政策研究では、住民が行政と接点を持つ際に生じる負担を **行政負担（Administrative burden）** と捉え、負担を **Learning（学習）／Psychological（心理）／Compliance（手続）** の3つのコストで整理します。

重要なのは、**制度の複雑性と情報提示の設計そのものが、制度利用を押し下げうる「構造的な参入障壁」になり得る点** です。

- 参考：[Administrative Burden: Learning, Psychological, and Compliance Costs in Citizen-State Interactions](https://academic.oup.com/jpart/article-abstract/25/1/43/88595)

### 現状の観測と政策上の課題認識

この「入口でのつまずき」は、個人の努力不足ではなく、実務上も課題として観測・認識されています。

#### （１）相談が大量に発生している（制度の入口で詰まっている）

厚生労働省の速報値では、生活困窮者自立支援制度の新規相談受付件数が令和6年度合計 302,670件（※報告率49%の注記あり）とされています。制度の入口で「相談」自体が大きなボリュームになっている状況です。

- 参考：[生活困窮者自立支援制度における新規相談件数等速報値](https://www.mhlw.go.jp/content/001612625.pdf)

#### （２）窓口側でも負担軽減が政策目標になっている

デジタル庁の「自治体窓口DX」関連資料でも、住民側の課題として「必要な申請や書類が分からない」「どの窓口に行くべきか分からない」といった"判断と次の一手"に関する詰まりが明示されています。

- 参考：[自治体窓口DXSaaS概要説明資料](https://www.digital.go.jp/assets/contents/node/information/field_ref_resources/368bf896-1fe4-4c53-bccb-3167cd06eac8/38a6efd9/20251024_news_dxsaas_provide-public-offering_outline_05.pdf)

つまり、制度の入口では「正しい情報がある」だけでは足りず、住民が短時間で **自分ごとに理解し、判断し、行動に移れる形** で提示されないと、相談増や窓口回遊、そして断念につながりやすい——この構造が問題になります。


## 課題

行政制度のWebページは制度の「正確性」を重視して設計されている一方で、利用者が短時間で次の2点に到達しづらい構造になっています。

1. **自分が対象か（判断）**
2. **次に何をすべきか（行動）**

その結果、制度利用が入口で滞り、**相談増・窓口回遊・再手続き・未申請（取りこぼし）** を生みやすくなります。

要するに、**正しいことは書いてあるにもかかわらず、文字量が多く、言い回しが難しく、情報が分散しているために、読まれず使われない**——この状態が解決したい中核課題です。

### なぜ「現場の努力」では解消しないか

自治体・省庁・関連機関が保有する膨大な公的ページを、制度改定に追随しながら、ケース分岐も含めて常に理解が容易な形式で再編集し続けるのは、人的運用ではスケールしません。結果として、"正確だが到達できない" 情報提示が残り、制度利用に失敗しやすい構造が固定化されます。

加えて、公的ページは誤りがあった場合の影響・責任が大きく、スピード感をもった更新・改善が進みにくい点も課題です。


## 目的：行政情報の「理解の入口」を自動生成し、断念を減らす

KOMANAVI（コマナビ）は、**行政ページのURLを入力するだけ** で、ページの内容をAIが解析し、出典付きの構造化された概要・やさしい要約を自動生成するWebアプリケーションです。生成された概要をもとに **深掘りチャット** で疑問を掘り下げたり、**意図入力** で「本当に実現したいこと」を伝えると、ユーザーの目的に最適化されたチェックリストと4コマ漫画を提供します。

利用者が短時間で内容を自分ごととして理解し、次の一手に進むための **「理解の入口」** ——それがKOMANAVIの目的です。

ログインユーザーはMyページにプロフィール（年齢・職業・居住地など）を登録でき、要約・チェックリスト・漫画の生成内容がユーザーの属性に応じて自動でパーソナライズされます。これにより、膨大なページを人手で再編集し続ける必要がない形で、前述のスケール制約にも対応します。

### 解決策として「漫画」を採用する理由

KOMANAVIが漫画を採用するのは、制度の入口で発生する学習・心理コストを下げ、断念を減らすうえで合理性があるためです。

#### 1. 学習コストを最短化できる

視覚情報と文章を組み合わせる提示は、言語・非言語の二重チャネルで理解・記憶を支援しやすい。

- 参考：[Dual-Coding Theory](https://www.sciencedirect.com/topics/neuroscience/dual-coding-theory)

#### 2. 心理コスト（不安）を下げ、"断念"を減らせる

漫画的説明（graphic narrative）が、難しい説明の理解を高め、手技前不安を低減したランダム化試験が報告されている。

- 参考：[Medical Graphic Narratives to Improve Patient Comprehension and Periprocedural Anxiety Before Coronary Angiography and Percutaneous Coronary Intervention: A Randomized Trial](https://pubmed.ncbi.nlm.nih.gov/30959523/)


## プロダクト詳細

### 利用シナリオ

KOMANAVIの利用の流れは以下の通りです。

1. ユーザーが行政ページのURLを入力
2. AIがページ内容を解析し、構造化された概要を提示
3. ユーザーが深掘りチャットや意図入力で「知りたいこと」を明確化
4. パーソナライズされた回答・チェックリスト・漫画を生成

URLを貼るだけで始められるシンプルな導線で、ITに不慣れなユーザーでも迷わず利用できることを重視しています。

### 機能 1：「ページ概要」で行政ページを1分で把握

行政ページのURLを入力すると、AIがGoogle Search Groundingを活用してページ内容を取得・解析し、以下の構造で概要を生成します。

| 表示項目 | 内容 |
|---------|------|
| **30秒で把握** | ページ全体の結論を1文で |
| **だれ向けの情報か** | 対象者の目安 |
| **このページで実現できること** | 具体的な成果（最大3件） |
| **最重要ポイント** | 制度利用の成否に直結する事実を表形式で |
| **見落とすと困る注意点** | 期限・例外条件など |
| **問い合わせ情報** | 電話番号・窓口・受付時間 |

すべての情報に **証跡URL（出典）** を紐づけており、「AIが何を根拠にしているか」を常に確認できます。

### 機能 2：「深掘りチャット」と「意図入力」でパーソナライズ

概要の確認後、ユーザーは2つの方法でさらに詳しく知ることができます。

**深掘りチャット**

概要を起点に、気になるトピックをチャット形式で掘り下げられます。20件を超えるメッセージは自動要約され、文脈を維持したまま会話を続けられます。

**意図入力**

「児童手当の申請方法が知りたい」など、自分の目的を一文で入力すると、ユーザーの意図に最適化された回答を再生成します。Myページに登録したプロフィール（年齢・職業・居住地など）があれば、属性に応じた出し分けも自動で行われます。

### 機能 3：「チェックリスト」で次の行動を明確に

中間表現をもとに、ユーザーが次に取るべきアクションをチェックリスト形式で生成します。

- 必要な書類
- 手続きのステップ
- 期限・締め切り
- 問い合わせ先

チェック状態はローカルに保存され、準備の進捗を管理できます。

### 機能 4：「4コマ漫画」で直感的に理解

解析結果をもとに、Gemini の画像生成モデルで4コマ漫画を自動生成します。Myページで登録した外見の特徴や性格を反映し、**ユーザー自身を主人公にしたパーソナライズ漫画** を生成できます。

漫画生成は非同期で処理され、ユーザーは結果画面でそのまま待つことなく他の情報を確認できます。

### 機能 5：信頼性を担保する設計

AIが生成した情報を鵜呑みにしないための仕組みをプロダクト全体に組み込んでいます。

- **根拠表示**：すべての生成結果に原文の出典を表示
- **免責事項**：「参考情報であること」を明示するバナーとモーダル
- **Google Search Attribution**：検索クエリと参照元URLをUI上に表示（Google利用規約準拠）


## システムアーキテクチャ

### 全体構成

![architecture.md](../images/system_architecture.svg)

### 技術スタック

| カテゴリ | 技術 |
|----------|------|
| **フロントエンド** | Next.js 16.1 / React 19 / Tailwind CSS 4 |
| **状態管理** | Zustand |
| **AI（解析）** | Vertex AI Gemini 3.0 Flash + Google Search Grounding |
| **AI（漫画生成）** | Vertex AI Gemini 3.0 Pro Image |
| **認証** | NextAuth v5 + Firebase Auth（Google OAuth + メール/パスワード） |
| **データベース** | Cloud Firestore（会話履歴・ユーザープロフィール） |
| **ストレージ** | Cloud Storage（漫画画像の永続化） |
| **非同期処理** | Cloud Tasks + Cloud Run Worker サービス |
| **デプロイ** | Cloud Run（asia-northeast1） |
| **CI/CD** | Cloud Build → Artifact Registry |

### データフロー

KOMANAVIの処理は、以下のパイプラインで構成されています。

```
URL入力
  → Google Search Grounding（ページ内容取得）
  → 中間表現生成（構造化JSON）
  → ページ概要生成 + やさしい要約生成
  → 深掘りチャット / 意図入力（ユーザー操作）
  → 意図回答 + チェックリスト生成
  → 4コマ漫画生成（Cloud Tasks 経由で非同期）
```

中間表現（IntermediateRepresentation）がパイプラインの中核を担い、ドキュメントの種類（給付・手続き・情報提供・FAQ・ガイド等）に応じた汎用的な構造で情報を保持します。この中間表現から要約・チェックリスト・漫画がそれぞれ独立に生成される設計です。

### Cloud Run を利用した最小コスト構成

フロントエンド兼APIサーバーと漫画生成Workerの2つのCloud Runサービスで構成しています。

- **komanavi**（メインサービス）：Next.js の standalone モードでビルドし、リクエスト発生時にのみ起動
- **komanavi-worker**（Workerサービス）：漫画生成の重い処理を分離し、Cloud Tasks からのOIDC認証付きHTTPリクエストで起動

Cloud Run はリクエストがないときにインスタンスを0にスケールダウンできるため、PoCフェーズのサーバーコストを最小限に抑えています。

### Google Search Grounding によるURL解析

当初はCheerioを使ったHTMLスクレイピングでページ内容を取得していましたが、以下の課題から **Google Search Grounding** に完全移行しました。

- PDFなど HTML以外の形式に対応できない
- JavaScriptレンダリングが必要なページの取得が困難
- スクレイピングではページの文脈情報が欠落しやすい

Google Search Groundingにより、URLを指定するだけでGeminiがWeb検索を通じてページ内容を取得し、参照元URLやクエリも自動で記録されます。これが出典表示の基盤にもなっています。

### 漫画生成の非同期アーキテクチャ

漫画生成は処理時間が長い（Gemini Pro Imageによる画像生成）ため、以下の非同期アーキテクチャを採用しています。

1. メインアプリが Firestore にジョブを作成し、Cloud Tasks にエンキュー
2. Cloud Tasks が Worker サービスにOIDC認証付きでHTTPリクエストを送信
3. Worker が Gemini Pro Image で漫画を生成し、Cloud Storage にアップロード
4. Firestore のジョブステータスを更新
5. クライアントがポーリングで完了を検知し、署名付きURLで画像を表示

ユーザーは漫画の生成を待つ間も、要約やチェックリストなど他の結果を確認できます。


## 設計で大切にしたこと

### 「やさしい日本語」の徹底

KOMANAVIのすべてのプロンプトに「専門用語を避ける」「1文を短く保つ」「主語と要点を明確に」といった制約を組み込んでいます。例えば、概要生成のプロンプトでは以下のルールを適用しています。

> 専門用語はそのまま残さず、必要なら言い換える（例: 「受給資格」→「受け取れる条件」）

ターゲットユーザーの第1優先は **ひとり親・高齢者の介護者・外国人住民・災害被災者** であり、最もシンプルで分かりやすいUIとフォントサイズ（18px以上）、高コントラストを採用しています。

### 原文への根拠参照を常に表示

AIが生成した情報には、必ず根拠となる原文の出典（Source）を紐づけています。中間表現の各項目がどのセクションの原文テキストに基づいているかを追跡できる構造にしており、利用者が「本当にそう書いてあるのか」を自分で確認できます。


## おわりに

行政の情報は「正確に書かれている」ことがほとんどです。しかし、最も支援を必要とする人ほど、その正確な情報に到達できないまま断念している——この構造的なギャップが、KOMANAVIが解きたい課題です。

URLを貼るだけで「自分が対象か」「次に何をすればいいか」がわかる。原文の出典が常に確認できる。漫画で直感的にイメージできる。KOMANAVIが、行政情報の「理解の入口」として、制度と人との距離を少しでも縮められればと思っています。
