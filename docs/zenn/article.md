## 背景

制度は「ある」のに、助けが届かない瞬間があります。

行政の支援を求めて制度のWebページを開いた人が、長い前提条件と例外、分岐だらけの手続きに圧倒され、「自分は対象なのか」が最後まで確信できず、必要書類も期限も見えないままタブを閉じてしまう——この"断念"が、最も支援を必要とする層ほど繰り返し起きています。

ひとり親、高齢者の介護者、外国人住民、災害被災者——緊急性が高く情報弱者になりやすい人ほど、行政ページを「読んで、理解して、行動に移す」ハードルが高いのが実情です。

### 公共政策研究に基づいた分析

公共政策研究では、住民が行政と接点を持つ際に生じる負担を **行政負担（Administrative burden）** と捉え、負担を **Learning（学習）／Psychological（心理）／Compliance（手続）** の3つのコストで整理します。

重要なのは、**制度の複雑性と情報提示の設計そのものが、制度利用を押し下げうる「構造的な参入障壁」になり得る点** です。

- 参考：[Administrative Burden: Learning, Psychological, and Compliance Costs in Citizen-State Interactions](https://academic.oup.com/jpart/article-abstract/25/1/43/88595)

### 現状の観測と政策上の課題認識

この「入口でのつまずき」は、個人の努力不足ではなく、実務上も課題として観測・認識されています。

#### （１）相談が大量に発生している（制度の入口で詰まっている）

厚生労働省の速報値では、生活困窮者自立支援制度の新規相談受付件数が令和6年度合計 302,670件（※報告率49%の注記あり）とされています。制度の入口で「相談」自体が大きなボリュームになっている状況です。

- 参考：[生活困窮者自立支援制度における新規相談件数等速報値](https://www.mhlw.go.jp/content/001612625.pdf)

#### （２）窓口側でも負担軽減が政策目標になっている

デジタル庁の「自治体窓口DX」関連資料でも、住民側の課題として「必要な申請や書類が分からない」「どの窓口に行くべきか分からない」といった"判断と次の一手"に関する詰まりが明示されています。

- 参考：[自治体窓口DXSaaS概要説明資料](https://www.digital.go.jp/assets/contents/node/information/field_ref_resources/368bf896-1fe4-4c53-bccb-3167cd06eac8/38a6efd9/20251024_news_dxsaas_provide-public-offering_outline_05.pdf)

つまり、制度の入口では「正しい情報がある」だけでは足りず、住民が短時間で **自分ごとに理解し、判断し、行動に移れる形** で提示されないと、相談増や窓口回遊、そして断念につながりやすい——この構造が問題になります。


## 課題

行政制度のWebページは制度の「正確性」を重視して設計されている一方で、利用者が短時間で次の2点に到達しづらい構造になっています。

1. **自分が対象か（判断）**
2. **次に何をすべきか（行動）**

その結果、制度利用が入口で滞り、**相談増・窓口回遊・再手続き・未申請（取りこぼし）** を生みやすくなります。

要するに、**正しいことは書いてあるにもかかわらず、文字量が多く、言い回しが難しく、情報が分散しているために、読まれず使われない**——この状態が解決したい中核課題です。

### なぜ「現場の努力」では解消しないか

自治体・省庁・関連機関が保有する膨大な公的ページを、制度改定に追随しながら、ケース分岐も含めて常に理解が容易な形式で再編集し続けるのは、人的運用ではスケールしません。結果として、"正確だが到達できない" 情報提示が残り、制度利用に失敗しやすい構造が固定化されます。

加えて、公的ページは誤りがあった場合の影響・責任が大きく、スピード感をもった更新・改善が進みにくい点も課題です。


## 目的：行政情報の「理解の入口」を自動生成し、断念を減らす

KOMANAVI（コマナビ）は、**行政ページのURLを入力するだけ** で、ページの内容をAIが解析し、出典付きの構造化された概要・やさしい要約を自動生成するWebアプリケーションです。生成された概要をもとに **深掘りチャット** で疑問を掘り下げたり、**意図入力** で「本当に実現したいこと」を伝えると、ユーザーの目的に最適化された**パーソナライズ回答・チェックリスト・漫画**を提供します。

利用者が短時間で内容を自分ごととして理解し、次の一手に進むための **「理解の入口」** ——それがKOMANAVIの目的です。

ログインユーザーはMyページにプロフィール（表示名・生年月日・性別・職業・国籍・居住地・外見の特徴・性格の8項目）を登録でき、要約・回答・チェックリスト・漫画のすべてがユーザーの属性に応じて自動でパーソナライズされます。これにより、膨大なページを人手で再編集し続ける必要がない形で、前述のスケール制約にも対応します。

### 解決策として「漫画」を採用する理由

KOMANAVIが漫画を採用するのは、制度の入口で発生する学習・心理コストを下げ、断念を減らすうえで合理性があるためです。

#### 1. 学習コストを最短化できる

視覚情報と文章を組み合わせる提示は、言語・非言語の二重チャネルで理解・記憶を支援しやすい。

- 参考：[Dual-Coding Theory](https://www.sciencedirect.com/topics/neuroscience/dual-coding-theory)

#### 2. 心理コスト（不安）を下げ、"断念"を減らせる

漫画的説明（graphic narrative）が、難しい説明の理解を高め、手技前不安を低減したランダム化試験が報告されている。

- 参考：[Medical Graphic Narratives to Improve Patient Comprehension and Periprocedural Anxiety Before Coronary Angiography and Percutaneous Coronary Intervention: A Randomized Trial](https://pubmed.ncbi.nlm.nih.gov/30959523/)


## プロダクト詳細

### 利用シナリオ

KOMANAVIの利用は**7ステップのガイドフロー**で進みます。各ステップの完了状態がUI上にリアルタイムで表示され、「今どこにいて、次に何をすればいいか」が常に明確です。

1. **URLを解析**：行政ページのURLを入力し、AIが内容を取得・解析
2. **要点を確認**：構造化された概要（ページ概要）を確認
3. **深掘りする**（任意）：気になるトピックをチャット形式で掘り下げ
4. **意図を入力**：「実現したいこと」を一文で入力
5. **漫画で確認**：内容を4〜8コマの漫画で直感的に理解
6. **あなた向けの回答を作成**：意図に最適化されたパーソナライズ回答を生成
7. **チェックリストを確認**：次に取るべきアクションを確認

URLを貼るだけで始められるシンプルな導線で、ITに不慣れなユーザーでも迷わず利用できることを重視しています。進捗インジケーターがステップごとの完了率をパーセンテージで表示し、ユーザーが途中で迷うことを防ぎます。

### 機能 1：「ページ概要」で行政ページを1分で把握

行政ページのURLを入力すると、AIがGoogle Search Groundingを活用してページ内容を取得・解析し、以下の構造で概要を生成します。

| 表示項目 | 内容 |
|---------|------|
| **30秒で把握** | ページ全体の結論を1文で |
| **だれ向けの情報か** | 対象者の目安 |
| **このページで実現できること** | 具体的な成果（最大3件） |
| **最重要ポイント** | 制度利用の成否に直結する事実を表形式で |
| **見落とすと困る注意点** | 期限・例外条件など |
| **問い合わせ情報** | 電話番号・窓口・受付時間 |

すべての情報に **証跡URL（出典）** を紐づけており、「AIが何を根拠にしているか」を常に確認できます。

### 機能 2：「深掘りチャット」と「意図入力」でパーソナライズ

概要の確認後、ユーザーは2つの方法でさらに詳しく知ることができます。

**深掘りチャット**

概要を起点に、気になるトピックをチャット形式で掘り下げられます。20件を超えるメッセージは自動要約され、文脈を維持したまま会話を続けられます。

**意図入力**

「児童手当の申請方法が知りたい」など、自分の目的を一文で入力すると、**Google Search Groundingによる意図ベースのWeb再検索**が実行され、ユーザーの意図に最適化された回答を新たに生成します。単に既存の情報を並べ替えるのではなく、意図に合わせて追加情報を収集し直す点がポイントです。Myページに登録したプロフィール（年齢・職業・居住地など）があれば、属性に応じた出し分けも自動で行われます。

意図入力から生成される回答は、以下の構造で提示されます。
- **結論**：最終判断を一文で
- **最初にやるべきこと**：最優先アクション
- **失敗リスク**：見落とすと困るポイント

### 機能 3：「チェックリスト」で次の行動を明確に

意図入力の結果をもとに、ユーザーが次に取るべきアクションをチェックリスト形式で生成します（最大15項目、時系列順）。

- 必要な書類
- 手続きのステップ
- 期限・締め切り
- 問い合わせ先

各項目にはカテゴリ（書類準備・手続き・確認事項など）と優先度が付与され、重要な項目は「重要」バッジで強調されます。プログレスバーで完了率が可視化され、すべてのタスクを完了すると達成メッセージが表示されます。チェック状態は保存され、準備の進捗を管理できます。

### 機能 4：「漫画」で直感的に理解

解析結果をもとに、Gemini の画像生成モデルで**4〜8コマの漫画**を自動生成します。コマ数とコマの内容は、ドキュメントの種類（給付・手続き・情報提供・FAQ・ガイドなど）に応じて自動で最適化されます。

- **給付制度**の場合：金額 → 対象者 → 期限の順で構成
- **手続き系**の場合：手順 → 必要書類 → 期限の順で構成
- 注意事項やよくある失敗パターンも優先的にコマに盛り込まれます

Myページで登録した外見の特徴や性格を反映し、**ユーザー自身を主人公にしたパーソナライズ漫画** を生成できます。

漫画生成は非同期で処理され、ユーザーは結果画面でそのまま待つことなく他の情報を確認できます。

### 機能 5：信頼性を担保する設計

AIが生成した情報を鵜呑みにしないための仕組みをプロダクト全体に組み込んでいます。

- **根拠表示**：すべての生成結果に原文の出典を表示
- **免責事項**：「参考情報であること」を明示するバナーとモーダル
- **Google Search Attribution**：検索クエリと参照元URLをUI上に表示（Google利用規約準拠）

### 機能 6：「会話履歴」で過去の解析をいつでも再参照

ログインユーザーの解析結果はCloud Firestoreに自動保存され、サイドバーからいつでも過去の解析を呼び出せます。

- 解析結果（概要・チェックリスト・意図回答・漫画）を一括保存
- チェックリストの進捗状態も保持されるため、途中から再開可能
- 不要な履歴は個別に削除可能

ページ離脱時にも `keepalive` 対応のAPIで確実に保存されるため、「せっかくの解析結果が消えた」という事態を防ぎます。


## システムアーキテクチャ

### 全体構成

![architecture.md](../images/system_architecture.svg)

### 技術スタック

| カテゴリ | 技術 |
|----------|------|
| **フロントエンド** | Next.js 16.1.1 / React 19.2.3 / Tailwind CSS 4 |
| **状態管理** | Zustand 5 |
| **AI SDK** | @google/genai（Vertex AI 経由） |
| **AI（解析）** | Gemini 3.0 Flash（gemini-3-flash-preview）+ Google Search Grounding |
| **AI（漫画生成）** | Gemini 3.0 Pro Image（gemini-3-pro-image-preview） |
| **認証** | NextAuth v5 + Firebase Auth（Google OAuth + メール/パスワード） |
| **データベース** | Cloud Firestore（会話履歴・解析結果・中間表現・ユーザープロフィール） |
| **ストレージ** | Cloud Storage（漫画画像の永続化） |
| **非同期処理** | Cloud Tasks + Cloud Run Worker サービス（Express.js） |
| **デプロイ** | Cloud Run（asia-northeast1）/ Node.js 20 |
| **CI/CD** | Cloud Build → Artifact Registry → Cloud Run |

### データフロー

KOMANAVIの処理は、以下のパイプラインで構成されています。すべてのAI処理は単一のエンドポイント（`/api/analyze`）に統合され、`mode` パラメータで処理を分岐します。

```
[1] URL入力（mode: default）
  → Google Search Grounding（ページ内容取得）
  → ドキュメントタイプ判定（6種類: benefit/procedure/information/faq/guide/other）
  → 中間表現生成（構造化JSON）
  → ページ概要 + やさしい要約の並列生成

[2] 深掘りチャット（mode: deep-dive）
  → 中間表現 + チャット履歴をコンテキストとしてLLM呼び出し
  → 20件超のメッセージは自動要約で文脈を圧縮

[3] 意図入力（mode: intent）
  → Google Search Groundingによる意図ベースWeb再検索
  → 意図回答 + チェックリスト（mode: checklist）の並列生成

[4] 漫画生成（Cloud Tasks 経由で非同期）
  → ドキュメントタイプに応じたパネル構成を自動決定
  → Gemini Pro Image で4〜8コマの漫画を生成

[5] 会話履歴の自動保存（Firestore）
```

中間表現（IntermediateRepresentation）がパイプラインの中核を担い、ドキュメントの種類に応じた汎用的な構造で情報を保持します。この中間表現から要約・チェックリスト・漫画がそれぞれ独立に生成される設計です。中間表現はFirestoreに永続化され、会話履歴から再利用できます。

### Cloud Run を利用した最小コスト構成

フロントエンド兼APIサーバーと漫画生成Workerの2つのCloud Runサービスで構成しています。

- **komanavi**（メインサービス）：Next.js の standalone モードでビルドし、リクエスト発生時にのみ起動
- **komanavi-worker**（Workerサービス）：Express.jsベースの漫画生成サービス。Cloud Tasks からのOIDC認証付きHTTPリクエストで起動（メモリ512Mi / タイムアウト600秒）

Cloud Run はリクエストがないときにインスタンスを0にスケールダウンできるため、PoCフェーズのサーバーコストを最小限に抑えています。

### Google Search Grounding によるURL解析

当初はCheerioを使ったHTMLスクレイピングでページ内容を取得していましたが、以下の課題から **Google Search Grounding** に完全移行しました。

- PDFなど HTML以外の形式に対応できない
- JavaScriptレンダリングが必要なページの取得が困難
- スクレイピングではページの文脈情報が欠落しやすい

Google Search Groundingにより、URLを指定するだけでGeminiがWeb検索を通じてページ内容を取得し、参照元URLやクエリも自動で記録されます。これが出典表示の基盤にもなっています。

### 漫画生成の非同期アーキテクチャ

漫画生成は処理時間が長い（Gemini Pro Imageによる画像生成）ため、以下の非同期アーキテクチャを採用しています。

1. メインアプリが Firestore（`conversation_manga` コレクション）にジョブを作成し、Cloud Tasks にエンキュー
2. Cloud Tasks が Worker サービスにOIDC認証付きでHTTPリクエストを送信
3. Worker がドキュメントタイプに応じたパネル構成を決定（4〜8コマ）
4. Gemini Pro Image に `responseModalities: ['TEXT', 'IMAGE']` で漫画を生成
5. Cloud Storage にアップロード（パス: `users/{userId}/manga/{timestamp}-{uuid}.png`）
6. Firestore のジョブステータスをリアルタイム更新（30% → 50% → 70% → 85% → 100%）
7. クライアントが2秒間隔のポーリングで完了を検知し、署名付きURL（60分TTL）で画像を表示

ユーザーは漫画の生成を待つ間も、要約やチェックリストなど他の結果を確認できます。同一ユーザーの並行ジョブ制限や日次使用量制限も設けており、リソースの公平な利用を確保しています。


## 設計で大切にしたこと

### 「やさしい日本語」の徹底

KOMANAVIのすべてのプロンプトに「専門用語を避ける」「1文を短く保つ」「主語と要点を明確に」といった制約を組み込んでいます。例えば、概要生成のプロンプトでは以下のルールを適用しています。

> 専門用語はそのまま残さず、必要なら言い換える（例: 「受給資格」→「受け取れる条件」）

ターゲットユーザーの第1優先は **ひとり親・高齢者の介護者・外国人住民・災害被災者** であり、最もシンプルで分かりやすいUIとフォントサイズ（18px以上）、高コントラストを採用しています。

### 原文への根拠参照を常に表示

AIが生成した情報には、必ず根拠となる原文の出典（Source）を紐づけています。中間表現の各項目がどのセクションの原文テキストに基づいているかを追跡できる構造にしており、利用者が「本当にそう書いてあるのか」を自分で確認できます。

### 7ステップのガイドフローで「迷わせない」

行政情報の理解という複雑なタスクを、7つの明確なステップに分解し、進捗インジケーターで現在地を常に表示しています。

各ステップの状態（未着手・進行中・完了）は30以上のコンテキストフラグから自動判定されるため、ユーザーが手動で管理する必要はありません。デスクトップ表示ではスクロール時にコンパクトなスティッキーバーが表示され、ページのどこにいても次のアクションが一目でわかります。

### パーソナライズの設計

ユーザープロフィールは8項目（表示名・生年月日・性別・職業・国籍・居住地・外見の特徴・性格）で構成されています。これらの属性は以下の形でAI生成に反映されます。

- **要約・回答**：年齢・職業・居住地に応じた制度の該当可能性を優先的に提示
- **チェックリスト**：居住地や国籍に応じた手続きの分岐を反映
- **漫画**：外見の特徴と性格をキャラクターに反映し、ユーザー自身を主人公にした漫画を生成

すべてのLLMプロンプトに共通のパーソナライズブロックを注入する設計としており、新しい生成機能を追加する際にも一貫したパーソナライズが適用されます。


## おわりに

行政の情報は「正確に書かれている」ことがほとんどです。しかし、最も支援を必要とする人ほど、その正確な情報に到達できないまま断念している——この構造的なギャップが、KOMANAVIが解きたい課題です。

URLを貼るだけで「自分が対象か」「次に何をすればいいか」がわかる。原文の出典が常に確認できる。漫画で直感的にイメージできる。KOMANAVIが、行政情報の「理解の入口」として、制度と人との距離を少しでも縮められればと思っています。
