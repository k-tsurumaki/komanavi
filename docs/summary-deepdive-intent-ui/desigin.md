## ページ概要生成・深掘り導線・意図入力UI 設計書

### 1. 目的
- F-003（ページ概要提示）、F-004（概要の深掘り）、F-005（ユーザー意図入力）を段階表示で実装する。
- 既存の要約表示を流用し、深掘りはチャット形式で提供する。
- 意図入力を確定した時点で「回答生成開始」に遷移させる。
- 概要は「何が分かるか／何ができるか」に加えて「対象者の目安」を必ず含める。

### 2. スコープ
- 対象フェーズ: 理解フェーズ（概要提示・深掘り）〜目的フェーズ（意図入力確定）。
- MVPではメッセージ履歴を永続保存しない（クライアント状態のみ）。
- チャットは解析API拡張（Option B）で実装する。
- 意図サジェストはスコープ外（将来検討）。
- モード切替のプルダウンは採用せず、「自動遷移＋明示ボタン」で運用する。

### 3. 画面・体験（段階表示）
#### 3.1 段階定義
1. 概要提示: 解析済みページの概要を表示。
2. 深掘りチャット: 主要トピック/セクションを起点に質問できる。
3. 意図入力: 「知りたいことを一文で」入力して確定。
4. 回答生成開始: 意図確定と同時に後続生成フェーズへ移行。

#### 3.4 概要表示の内容要件（F-003）
- テーマ（ページ全体の主題）
- このページの対象者
- 目的（ページで何が分かるか／何ができるか。難しい内容を平易に明示）
- 主要トピックの提示と整理（3〜5件）
- 表示形式はMarkdown（見出し＋箇条書き）

#### 3.3 段階インジケーター文言
- 概要: 「概要を確認」
- 深掘り: 「質問して深掘り」
- 意図: 「知りたいことを確定」
- 生成: 「回答を作成中」

#### 3.2 主要UI要素
- 概要表示: 既存の要約表示コンポーネントを流用。
- 深掘りチャット: 会話履歴、自由入力欄、送信ボタン。
- 意図入力: 単文入力欄、例文ヒント。
- 明示ボタン: 「意図入力へ進む」を常設。
- 段階インジケーター: 現在フェーズを明示。

### 4. フロー
1. 解析完了後、概要を表示（段階1）。
2. ユーザーが深掘りチャットを開始（段階2）。
3. 深掘りの内容についてLLMが回答を実施して意図入力欄を表示（段階3）。
4. 意図確定 → 回答生成を開始（段階4）。

#### 4.1 深掘りチャットの終了条件
- 「意図入力へ進む」押下で終了。
- 終了時に要点を自動要約し、直後に意図入力欄を表示する。

### 5. 実装方針
#### 5.1 フロントエンド
- 既存の結果ページに段階表示を統合し、`phase` で表示を切り替える。
- 深掘りチャットは自由入力のみとし、送信ボタンでAPI呼び出し。
- 「意図入力へ進む」押下で要点要約を生成し、意図入力欄へ遷移。

#### 5.2 状態管理
- `phase` / `messages` / `intent` / `focus` / `deepDiveSummary` をストアに追加。
- `messages` は最大10往復、超過分は要約して `deepDiveSummary` に統合。

#### 5.3 API
- 解析APIに `mode: deepDive` を追加し、チャット回答と要約を返却。
- 入力は `summary` + `messages` + `focus` を最小セットとする。

#### 5.4 中間表現への接続
- 意図確定時に `user_goal` と `focus` を中間表現生成へ渡す。
- 深掘り要約は `intent_summary` 作成の補助に利用する。