# KOMANAVI ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»è¨­è¨ˆèª²é¡Œ

**ä½œæˆæ—¥**: 2026-02-08
**èª¿æŸ»ç¯„å›²**: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€ä¼šè©±å±¥æ­´ç®¡ç†ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æƒ…å ±ç®¡ç†

---

## ğŸ“‹ æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€KOMANAVIã®èªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹æ—¢çŸ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª²é¡Œã¨è¨­è¨ˆä¸Šã®å•é¡Œç‚¹ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚å„èª²é¡Œã«ã¯å„ªå…ˆåº¦ã€å½±éŸ¿ç¯„å›²ã€ç¾çŠ¶ã®çŠ¶æ…‹ã€æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ”´ CRITICALï¼ˆé‡å¤§ï¼‰

### 1. Firestore Rules ã¨ NextAuth ã®èªè¨¼IDä¸æ•´åˆ

**å•é¡Œã®è©³ç´°**:
- Firestore Security Rules ã¯ `request.auth.uid`ï¼ˆFirebase Auth ã® UIDï¼‰ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- NextAuthï¼ˆGoogle OAuthï¼‰ã¯ `account.providerAccountId`ï¼ˆGoogle ãŒç™ºè¡Œã™ã‚‹ä¸€æ„IDï¼‰ã‚’ `session.user.id` ã«è¨­å®š
- ã“ã®2ã¤ã®IDã¯**ç•°ãªã‚‹å€¤**ã«ãªã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ Firestore ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«èªè¨¼ãŒæ©Ÿèƒ½ã—ãªã„

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```javascript
// firestore.rules:9-11
function isOwner(userId) {
  return isSignedIn() && request.auth.uid == userId;
}
```

```typescript
// src/lib/auth.config.ts:19-20
} else if (account?.providerAccountId) {
  token.id = account.providerAccountId;  // Google OAuth ã®å ´åˆ
```

**ç¾çŠ¶ã®å½±éŸ¿**:
- **ç¾åœ¨ã¯å•é¡Œãªã—**: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã¯ Admin SDK çµŒç”±ã§è¡Œã‚ã‚Œã¦ãŠã‚Šã€Firestore Rules ã¯ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹
- **å°†æ¥ã®ãƒªã‚¹ã‚¯**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ç›´æ¥ Firestore ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å®Ÿè£…ã‚’è¿½åŠ ã—ãŸå ´åˆã€èªè¨¼ãŒå®Œå…¨ã«æ©Ÿèƒ½ã—ãªã„

**å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**:
- `conversation_histories`
- `conversation_results`
- `conversation_intermediates`
- `conversation_manga`

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ Aï¼ˆæ¨å¥¨ï¼‰**: ã™ã¹ã¦ã®èªè¨¼ã‚’ Firebase Auth ã«çµ±ä¸€
```typescript
// Google OAuth ã‚‚ Firebase Auth çµŒç”±ã§è¡Œã†
// NextAuth ã® Credentials ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ Firebase IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
// session.user.id = Firebase UID ã§çµ±ä¸€
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B**: Firestore Rules ã‚’å‰Šé™¤ã—ã€ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ Admin SDK å´ã§è¡Œã†
```javascript
// firestore.rules
service cloud.firestore {
  match /databases/{database}/documents {
    // ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ C**: ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨
- Firebase Auth ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã« `providerAccountId` ã‚’è¿½åŠ 
- Firestore Rules ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼

**å„ªå…ˆåº¦**: ğŸ”´ CRITICALï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè£…ã™ã‚‹å‰ã«å¿…ãšå¯¾å¿œï¼‰

---

## ğŸŸ¡ HIGHï¼ˆé«˜ï¼‰

### 2. `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã« Firestore Security Rules ãŒæœªå®šç¾©

**å•é¡Œã®è©³ç´°**:
- `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãƒ«ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€**å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒèª­ã¿æ›¸ãå¯èƒ½**ã«ãªã‚‹

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```javascript
// firestore.rules ã«ã¯ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„
// æœ€çµ‚è¡Œã¯ line 37 ã§çµ‚ã‚ã£ã¦ãŠã‚Šã€users ã®ãƒ«ãƒ¼ãƒ«ãŒãªã„
```

**ç¾çŠ¶ã®å½±éŸ¿**:
- **ç¾åœ¨ã¯å•é¡Œãªã—**: `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ Admin SDK çµŒç”±ã®ã¿ï¼ˆ`src/app/api/user/profile/route.ts`ï¼‰
- **å°†æ¥ã®ãƒªã‚¹ã‚¯**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å®Ÿè£…ã‚’è¿½åŠ ã—ãŸå ´åˆã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³ã®ãƒªã‚¹ã‚¯

**ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€‹äººæƒ…å ±**:
- æ°åï¼ˆ`displayName`ï¼‰
- ç”Ÿå¹´æœˆæ—¥ï¼ˆ`birthDate`ï¼‰
- æ€§åˆ¥ï¼ˆ`gender`ï¼‰
- è·æ¥­ï¼ˆ`occupation`ï¼‰
- å›½ç±ï¼ˆ`nationality`ï¼‰
- å±…ä½åœ°ï¼ˆ`location`ï¼‰
- å¤–è¦‹çš„ç‰¹å¾´ï¼ˆ`visualTraits`ï¼‰
- æ€§æ ¼ï¼ˆ`personality`ï¼‰

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

```javascript
// firestore.rules ã«è¿½åŠ 
match /users/{userId} {
  // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
  allow read, write: if isOwner(userId);
}
```

**å„ªå…ˆåº¦**: ğŸŸ¡ HIGHï¼ˆå€‹äººæƒ…å ±ä¿è­·ã®ãŸã‚æ—©æ€¥ã«å¯¾å¿œæ¨å¥¨ï¼‰

---

### 3. ä¼šè©±å±¥æ­´å‰Šé™¤æ™‚ã«é–¢é€£ã™ã‚‹æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œãªã„

**å•é¡Œã®è©³ç´°**:
- ä¼šè©±å±¥æ­´å‰Šé™¤APIï¼ˆ`DELETE /api/history/:historyId`ï¼‰ã§ `conversation_manga` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œãªã„
- å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ¼«ç”»ç”»åƒã¨ç”Ÿæˆãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚Šç¶šã‘ã‚‹

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/[historyId]/route.ts:126-132
const batch = db.batch();
batch.delete(historyRef);

if (resultId) {
  batch.delete(db.collection(COLLECTIONS.results).doc(resultId));
  batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));
  // âŒ conversation_manga ã¯å‰Šé™¤ã•ã‚Œãªã„
}
```

**ç¾çŠ¶ã®å½±éŸ¿**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ãŒæ®‹å­˜
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆã®å¢—åŠ 
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒªã‚¹ã‚¯ï¼ˆå‰Šé™¤ã—ãŸã¤ã‚‚ã‚Šã®ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹ï¼‰
- GDPRç­‰ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤è¦æ±‚ã«å¯¾å¿œã§ããªã„

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

```typescript
// src/app/api/history/[historyId]/route.ts:126-135
const batch = db.batch();
batch.delete(historyRef);

if (resultId) {
  batch.delete(db.collection(COLLECTIONS.results).doc(resultId));
  batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));

  // æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
  batch.delete(db.collection('conversation_manga').doc(resultId));

  // Cloud Storage ã®ç”»åƒã‚‚å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  // const storage = getAdminStorage();
  // const bucket = storage.bucket();
  // await bucket.deleteFiles({ prefix: `manga/${resultId}/` });
}
```

**å‚è€ƒ**: Firestore Rules ã§ã¯ `conversation_manga` ã®ãƒ«ãƒ¼ãƒ«ã¯å®šç¾©æ¸ˆã¿ï¼ˆfirestore.rules:28-31ï¼‰

**å„ªå…ˆåº¦**: ğŸŸ¡ HIGHï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·æ³•ä»¤å¯¾å¿œã®ãŸã‚æ—©æ€¥ã«å¯¾å¿œæ¨å¥¨ï¼‰

---

## ğŸŸ  MEDIUMï¼ˆä¸­ï¼‰

### 4. ä¼šè©±å±¥æ­´å‰Šé™¤æ™‚ã®æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ãŒä¸å®Œå…¨

**å•é¡Œã®è©³ç´°**:
- å‰Šé™¤APIã§ `historyId` ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã¯å®Ÿæ–½ã—ã¦ã„ã‚‹ãŒã€`resultId` ãŠã‚ˆã³ `intermediateId` ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¦ã„ãªã„
- ç†è«–ä¸Šã€ä»–äººã® `resultId` ã‚’å‚ç…§ã™ã‚‹å±¥æ­´ã‚’ä½œæˆã—ã€ãã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/[historyId]/route.ts:120-132
const historyData = historySnap.data();
if (!historyData || historyData.userId !== userId) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
// âœ… historyId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚ã‚Š

const resultId = historyData.resultId as string | undefined;
const batch = db.batch();
batch.delete(historyRef);

if (resultId) {
  batch.delete(db.collection(COLLECTIONS.results).doc(resultId));
  // âŒ resultId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ãªã—
  batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));
  // âŒ intermediateId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ãªã—
}
```

**æ¯”è¼ƒ**: GET API ã§ã¯æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹
```typescript
// src/app/api/history/[historyId]/route.ts:68-72
if (resultSnap.exists) {
  const resultData = resultSnap.data();
  if (resultData?.userId !== userId) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  // âœ… GET ã§ã¯ resultId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚ã‚Š
```

**ç¾çŠ¶ã®å½±éŸ¿**:
- **å®Ÿéš›ã®æ”»æ’ƒã¯å›°é›£**: POST API ã§ `resultId` ã¨ `historyId` ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ãŸã‚ã€ä»–äººã® `resultId` ã‚’å‚ç…§ã™ã‚‹å±¥æ­´ã®ä½œæˆã¯é›£ã—ã„
- **é˜²å¾¡ã®æ·±ã•ï¼ˆDefense in Depthï¼‰ã®è¦³ç‚¹**: å˜ä¸€ã®é˜²å¾¡ç­–ã«ä¾å­˜ã™ã‚‹ã®ã¯æ¨å¥¨ã•ã‚Œãªã„

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

```typescript
// src/app/api/history/[historyId]/route.ts:126-145
if (resultId) {
  // resultId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
  const resultRef = db.collection(COLLECTIONS.results).doc(resultId);
  const resultSnap = await resultRef.get();

  if (resultSnap.exists) {
    const resultData = resultSnap.data();
    if (resultData?.userId !== userId) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }
  }

  // ãƒã‚§ãƒƒã‚¯å¾Œã«å‰Šé™¤
  const batch = db.batch();
  batch.delete(historyRef);
  batch.delete(resultRef);
  batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));
  batch.delete(db.collection('conversation_manga').doc(resultId));

  await batch.commit();
}
```

**å„ªå…ˆåº¦**: ğŸŸ  MEDIUMï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚å¯¾å¿œæ¨å¥¨ï¼‰

---

### 5. `requireUserId()` é–¢æ•°ã®å‘½åã¨å®Ÿè£…ã®ä¸ä¸€è‡´

**å•é¡Œã®è©³ç´°**:
- é–¢æ•°åã¯ `requireUserId()`ï¼ˆå¿…é ˆï¼‰ã ãŒã€å®Ÿéš›ã«ã¯ `null` ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹
- å‘¼ã³å‡ºã—å´ã§æ¯å› null ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã«ãªã‚Šã€ãƒã‚§ãƒƒã‚¯æ¼ã‚Œã®ãƒªã‚¹ã‚¯ãŒã‚ã‚‹

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/utils.ts:14-17
export async function requireUserId(): Promise<string | null> {
  const session = await auth();
  return session?.user?.id ?? null;  // âŒ null ã‚’è¿”ã™å¯èƒ½æ€§
}
```

**å‘¼ã³å‡ºã—å´ã®å¯¾å¿œ**:
```typescript
// ã™ã¹ã¦ã® API ã§ null ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦
const userId = await requireUserId();
if (!userId) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A**: ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ï¼ˆé–¢æ•°åã«åˆã‚ã›ã‚‹ï¼‰
```typescript
export async function requireUserId(): Promise<string> {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error('Unauthorized');
  }
  return session.user.id;
}

// å‘¼ã³å‡ºã—å´
try {
  const userId = await requireUserId();
  // null ãƒã‚§ãƒƒã‚¯ä¸è¦
} catch {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B**: é–¢æ•°åã‚’å¤‰æ›´ã™ã‚‹
```typescript
export async function getUserId(): Promise<string | null> {
  const session = await auth();
  return session?.user?.id ?? null;
}

// å‘¼ã³å‡ºã—å´ã§ null ãƒã‚§ãƒƒã‚¯ï¼ˆç¾çŠ¶ã¨åŒã˜ï¼‰
```

**å„ªå…ˆåº¦**: ğŸŸ  MEDIUMï¼ˆã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§å‘ä¸Šã®ãŸã‚å¯¾å¿œæ¨å¥¨ï¼‰

---

### 6. åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç•°ãªã‚‹èªè¨¼æ–¹æ³•ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ãªã‚‹

**å•é¡Œã®è©³ç´°**:
- Google OAuth ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã¨ã€Firebase ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã§ã€ç•°ãªã‚‹ `userId` ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹
- åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç•°ãªã‚‹èªè¨¼æ–¹æ³•ã‚’ä½¿ã†ã¨ã€ä¼šè©±å±¥æ­´ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒåˆ†æ–­ã•ã‚Œã‚‹

**è©²å½“ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/lib/auth.config.ts:14-24
jwt: async ({ token, user, account }) => {
  if (account?.provider === "firebase" || account?.type === "credentials") {
    if (user?.id) {
      token.id = user.id;  // Firebase UID
    }
  } else if (account?.providerAccountId) {
    token.id = account.providerAccountId;  // Google ã® providerAccountId
  } else if (user?.id) {
    token.id = user.id;
  }
  return token;
},
```

**å…·ä½“ä¾‹**:
| èªè¨¼æ–¹æ³• | userId | çµæœ |
|---------|--------|------|
| Google OAuth | `google-12345` | ä¼šè©±å±¥æ­´Aã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«A |
| Firebase ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | `firebase-abc123` | ä¼šè©±å±¥æ­´Bã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«B |

**ç¾çŠ¶ã®å½±éŸ¿**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç•°ãªã‚‹èªè¨¼æ–¹æ³•ã‚’ä½¿ã†ã¨ã€éå»ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚‹
- ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ãŒç™ºç”Ÿã™ã‚‹

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A**: èªè¨¼æ–¹æ³•ã‚’1ã¤ã«çµ±ä¸€
- ã™ã¹ã¦ã®èªè¨¼ã‚’ Firebase Auth çµŒç”±ã«çµ±ä¸€
- Google OAuth ã‚‚ Firebase Authentication ã® Google ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½ã‚’å®Ÿè£…
- NextAuth ã® [Account Linking](https://authjs.dev/guides/providers/custom-provider#account-linking) ã‚’ä½¿ç”¨
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«è¤‡æ•°ã®èªè¨¼æ–¹æ³•ã‚’åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ä»˜ã‘

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ C**: ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
- Firestore ã« `master_users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ã€è¤‡æ•°ã® `providerAccountId` / Firebase UID ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°

**å„ªå…ˆåº¦**: ğŸŸ  MEDIUMï¼ˆUXæ”¹å–„ã®ãŸã‚å¯¾å¿œæ¤œè¨ï¼‰

---

## ğŸŸ¢ LOWï¼ˆä½ï¼‰

### 7. API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæœªå®Ÿè£…

**å•é¡Œã®è©³ç´°**:
- ä¼šè©±å±¥æ­´ä¿å­˜APIï¼ˆ`POST /api/history`ï¼‰ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„
- æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤§é‡ã®å±¥æ­´ã‚’ä¿å­˜ã—ã€Firestore ã®ã‚³ã‚¹ãƒˆã‚’å¢—å¤§ã•ã›ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

**ç¾çŠ¶ã®å½±éŸ¿**:
- **ç¾åœ¨ã¯å•é¡Œãªã—**: ã‚µãƒ¼ãƒ“ã‚¹è¦æ¨¡ãŒå°ã•ãã€å®Ÿå®³ã¯ç™ºç”Ÿã—ã¦ã„ãªã„
- **å°†æ¥ã®ãƒªã‚¹ã‚¯**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒå¢—åŠ ã—ãŸå ´åˆã€DoSæ”»æ’ƒã‚„ã‚³ã‚¹ãƒˆå¢—å¤§ã®ãƒªã‚¹ã‚¯

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œç­–**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```typescript
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å®Ÿè£…
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1æ™‚é–“
  max: 100, // 1æ™‚é–“ã‚ãŸã‚Š100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  keyGenerator: (req) => req.userId, // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«åˆ¶é™
});
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B**: Firestore ãƒ«ãƒ¼ãƒ«ã§ã®åˆ¶é™
```javascript
// 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šã®å±¥æ­´æ•°ã‚’åˆ¶é™
match /conversation_histories/{historyId} {
  allow create: if isOwner(request.resource.data.userId)
    && getUserHistoryCount(request.resource.data.userId) < 1000;
}

function getUserHistoryCount(userId) {
  // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
  return get(/databases/$(database)/documents/user_stats/$(userId)).data.historyCount;
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ C**: Cloud Armor / Cloud Run ã®è¨­å®š
- Cloud Armor ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¨­å®š
- Cloud Run ã®æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã‚’åˆ¶é™

**å„ªå…ˆåº¦**: ğŸŸ¢ LOWï¼ˆã‚µãƒ¼ãƒ“ã‚¹è¦æ¨¡æ‹¡å¤§æ™‚ã«å¯¾å¿œï¼‰

---

## ğŸ“Š èª²é¡Œã®å„ªå…ˆåº¦ãƒãƒˆãƒªã‚¯ã‚¹

| å„ªå…ˆåº¦ | èª²é¡Œ | å½±éŸ¿ | å¯¾å¿œæœŸé™ |
|-------|-----|------|---------|
| ğŸ”´ CRITICAL | Firestore Rules ã¨ NextAuth ã®ä¸æ•´åˆ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«èªè¨¼ãŒæ©Ÿèƒ½ã—ãªã„ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´å®Ÿè£…å‰ã«å¿…é ˆ |
| ğŸŸ¡ HIGH | `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ«ãƒ¼ãƒ«ãŒãªã„ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³ã®ãƒªã‚¹ã‚¯ | 1-2é€±é–“ä»¥å†… |
| ğŸŸ¡ HIGH | `conversation_manga` ãŒå‰Šé™¤ã•ã‚Œãªã„ | ãƒ‡ãƒ¼ã‚¿ä¿è­·æ³•ä»¤é•åã®ãƒªã‚¹ã‚¯ | 1-2é€±é–“ä»¥å†… |
| ğŸŸ  MEDIUM | å‰Šé™¤æ™‚ã®æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ä¸å®Œå…¨ | ä»–äººã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®å¯èƒ½æ€§ï¼ˆç†è«–ä¸Šï¼‰ | 1ãƒ¶æœˆä»¥å†… |
| ğŸŸ  MEDIUM | `requireUserId()` ã®å‘½åã¨å®Ÿè£…ã®ä¸ä¸€è‡´ | ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ä½ä¸‹ | 1ãƒ¶æœˆä»¥å†… |
| ğŸŸ  MEDIUM | ç•°ãªã‚‹èªè¨¼æ–¹æ³•ã§ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | UXä½ä¸‹ã€ãƒ‡ãƒ¼ã‚¿åˆ†æ–­ | 2-3ãƒ¶æœˆä»¥å†… |
| ğŸŸ¢ LOW | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæœªå®Ÿè£… | ã‚³ã‚¹ãƒˆå¢—å¤§ã€DoSæ”»æ’ƒ | ã‚µãƒ¼ãƒ“ã‚¹è¦æ¨¡æ‹¡å¤§æ™‚ |

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ç¾åœ¨ã®è‰¯ã„ç‚¹

âœ… **èªè¨¼å¿…é ˆ**: ã™ã¹ã¦ã®APIã§ `requireUserId()` ã«ã‚ˆã‚‹èªè¨¼ãƒã‚§ãƒƒã‚¯
âœ… **æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯**: `userId` ã«ã‚ˆã‚‹æ‰€æœ‰è€…ç¢ºèªï¼ˆéƒ¨åˆ†çš„ï¼‰
âœ… **Firestore Rules**: ä¼šè©±å±¥æ­´é–¢é€£ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ«ãƒ¼ãƒ«å®šç¾©æ¸ˆã¿ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«æœ‰åŠ¹ï¼‰
âœ… **Admin SDK ä½¿ç”¨**: ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆç¾çŠ¶ã¯å®‰å…¨ï¼‰
âœ… **JWT ç½²å**: `AUTH_SECRET` ã«ã‚ˆã‚‹ç½²åã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ”¹ã–ã‚“é˜²æ­¢

### æ”¹å–„ãŒå¿…è¦ãªç‚¹

âŒ **èªè¨¼IDä¸æ•´åˆ**: Firestore Rules ã¨ NextAuth ã§ç•°ãªã‚‹IDã‚’ä½¿ç”¨
âŒ **ãƒ«ãƒ¼ãƒ«æœªå®šç¾©**: `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ãªã—
âŒ **å‰Šé™¤ä¸å®Œå…¨**: é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãªå‰Šé™¤ãŒæœªå®Ÿè£…
âŒ **æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ä¸è¶³**: ä¸€éƒ¨ã®APIã§æ‰€æœ‰è€…ç¢ºèªãŒä¸å®Œå…¨
âŒ **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—**: API ã®æ‚ªç”¨å¯¾ç­–ãŒæœªå®Ÿè£…

---

## ğŸ“ å¯¾å¿œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: ç·Šæ€¥å¯¾å¿œï¼ˆ1-2é€±é–“ï¼‰
1. `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã« Firestore Rules ã‚’è¿½åŠ 
2. ä¼šè©±å±¥æ­´å‰Šé™¤æ™‚ã« `conversation_manga` ã‚‚å‰Šé™¤ã™ã‚‹ã‚ˆã†ä¿®æ­£
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã®å¼·åŒ–ï¼ˆãƒ­ã‚°ç¢ºèªï¼‰

### Phase 2: é‡è¦å¯¾å¿œï¼ˆ1ãƒ¶æœˆï¼‰
1. Firestore Rules ã¨ NextAuth ã®èªè¨¼IDçµ±ä¸€ï¼ˆè¨­è¨ˆæ±ºå®šï¼‰
2. å‰Šé™¤APIã®æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯å¼·åŒ–
3. `requireUserId()` ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

### Phase 3: æ”¹å–„å¯¾å¿œï¼ˆ2-3ãƒ¶æœˆï¼‰
1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½ã®å®Ÿè£…
2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

### Phase 4: ç¶™ç¶šçš„æ”¹å–„
- å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼
- ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œï¼ˆGDPRã€å€‹äººæƒ…å ±ä¿è­·æ³•ï¼‰

---

## ğŸ” é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [èªè¨¼æ©Ÿèƒ½è¨­è¨ˆæ›¸](../auth/èªè¨¼æ©Ÿèƒ½è¨­è¨ˆæ›¸.md)
- [ä¼šè©±å±¥æ­´æ©Ÿèƒ½ è¨­è¨ˆæ›¸](../conversation-history/design.md)
- [Firestore è¨­å®šãƒ»é‹ç”¨ãƒ¡ãƒ¢](../conversation-history/deployment.md)
- [ç’°å¢ƒå¤‰æ•°è¨­å®š](../deploy/environment-variables.md)

---

## ğŸ“ å•ã„åˆã‚ã›

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µã‚„è¿½åŠ ã®èª²é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯ã€é–‹ç™ºãƒãƒ¼ãƒ ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚

**æœ€çµ‚æ›´æ–°**: 2026-02-08
