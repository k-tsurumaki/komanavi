# èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã®èª¿æŸ»å ±å‘Š

**èª¿æŸ»æ—¥**: 2026-02-08
**èª¿æŸ»è€…**: Claude Code
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: KOMANAVI èªè¨¼ãƒ»ä¼šè©±å±¥æ­´ãƒ»ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æƒ…å ±ç®¡ç†

---

## ğŸ“‹ èª¿æŸ»ã®ç›®çš„

KOMANAVIã«ãŠã‘ã‚‹èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€ä¼šè©±å±¥æ­´ç®¡ç†ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æƒ…å ±ç®¡ç†ã®ç¾çŠ¶ã‚’èª¿æŸ»ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¨è¨­è¨ˆä¸Šã®å•é¡Œç‚¹ã‚’ç‰¹å®šã™ã‚‹ã€‚

---

## ğŸ” 1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°èª¿æŸ»

### 1.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | æŠ€è¡“ | ç”¨é€” |
|--------------|------|------|
| èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | Auth.js (NextAuth.js v5) | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |
| èªè¨¼åŸºç›¤ | GCP Identity Platform | èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³æ–¹å¼ | JWT | ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ |
| èªè¨¼æ–¹æ³• | Google OAuth + Firebase ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | å¤šè¦ç´ èªè¨¼ |

### 1.2 èªè¨¼ãƒ•ãƒ­ãƒ¼

#### Google OAuth èªè¨¼ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
2. NextAuth ãŒGoogleã®èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   â†“
3. Googleã§èªè¨¼æˆåŠŸ
   â†“
4. NextAuth ã® jwt ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹
   â†“ account.providerAccountId ã‚’ token.id ã«è¨­å®š
5. NextAuth ã® session ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹
   â†“ token.id ã‚’ session.user.id ã«è¨­å®š
6. JWT ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã€ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜
   â†“
7. ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§JWTã‚’é€ä¿¡
   â†“
8. ã‚µãƒ¼ãƒãƒ¼å´ã§ auth() ã‚’å‘¼ã³å‡ºã—ã€session.user.id ã‚’å–å¾—
```

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/lib/auth.config.ts:19-20
} else if (account?.providerAccountId) {
  token.id = account.providerAccountId;  // â† Google ã®ä¸€æ„ID
```

**é‡è¦**: `providerAccountId` ã¯ Google ãŒç™ºè¡Œã™ã‚‹ä¸€æ„ã®IDï¼ˆä¾‹: `103234567890123456789`ï¼‰

#### Firebase ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
   â†“
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ Firebase SDK ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
   â†“
3. Firebase ãŒ IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ
   â†“
4. IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ NextAuth ã® Credentials ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«é€ä¿¡
   â†“
5. ã‚µãƒ¼ãƒãƒ¼å´ã§ Firebase Admin SDK ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
   â†“ verifyIdToken(idToken) â†’ decodedToken.uid
6. Firebase UID ã‚’ user.id ã«è¨­å®š
   â†“
7. NextAuth ã® jwt ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹
   â†“ user.id ã‚’ token.id ã«è¨­å®š
8. JWT ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã€ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜
```

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/lib/auth.ts:18-34
Credentials({
  id: "firebase",
  name: "Firebase",
  credentials: {
    idToken: { label: "ID Token", type: "text" },
  },
  authorize: async (credentials) => {
    const decodedToken = await verifyIdToken(credentials.idToken as string);
    return {
      id: decodedToken.uid,  // â† Firebase UID
      email: decodedToken.email,
      name: decodedToken.name || decodedToken.email?.split("@")[0],
      image: decodedToken.picture,
    };
  },
}),
```

**é‡è¦**: Firebase UID ã¯ Firebase ãŒç™ºè¡Œã™ã‚‹ä¸€æ„ã®IDï¼ˆä¾‹: `abc123XYZ456def789`ï¼‰

### 1.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

#### JWT ã®æ§‹é€ 
```json
{
  "id": "103234567890123456789",  // Google providerAccountId ã¾ãŸã¯ Firebase UID
  "email": "user@example.com",
  "name": "User Name",
  "iat": 1707359000,
  "exp": 1707445400,
  "jti": "..."
}
```

#### JWT ã®ç½²åã¨æ¤œè¨¼
- **ç½²åéµ**: `AUTH_SECRET` ç’°å¢ƒå¤‰æ•°ï¼ˆç§˜å¯†éµï¼‰
- **ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: HS256ï¼ˆHMAC-SHA256ï¼‰
- **æ¤œè¨¼**: NextAuth ãŒè‡ªå‹•çš„ã«ç½²åã‚’æ¤œè¨¼
- **æ”¹ã–ã‚“é˜²æ­¢**: ç½²åãŒä¸€è‡´ã—ãªã„å ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹ã«ãªã‚‹

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡**: âœ… **å®‰å…¨** - JWT ã¯ç½²åã•ã‚Œã¦ãŠã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ”¹ã–ã‚“ä¸å¯èƒ½

### 1.4 ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã®æµã‚Œ

```typescript
// API ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…
const userId = await requireUserId();
  â†“
// src/app/api/history/utils.ts:14-17
const session = await auth();
  â†“
// NextAuth ãŒ JWT ã‚’æ¤œè¨¼
// ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰ JWT ã‚’å–å¾— â†’ ç½²åæ¤œè¨¼ â†’ ãƒ‡ã‚³ãƒ¼ãƒ‰
  â†“
return session?.user?.id;  // token.id ã®å€¤ã‚’è¿”ã™
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡**: âœ… **å®‰å…¨** - ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯å¤‰ã‚ã‚‰ãšã€æ”¹ã–ã‚“ã‚‚ã§ããªã„

ãŸã ã—ã€**ç•°ãªã‚‹èªè¨¼æ–¹æ³•ã§ç•°ãªã‚‹IDã«ãªã‚‹å•é¡Œ**ã¯æ®‹ã‚‹ï¼ˆè©³ç´°ã¯èª²é¡Œ6ã‚’å‚ç…§ï¼‰

---

## ğŸ’¬ 2. ä¼šè©±å±¥æ­´ç®¡ç†ã®è©³ç´°èª¿æŸ»

### 2.1 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### Firestore ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ 
```
conversation_histories (å±¥æ­´ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)
â”œâ”€â”€ {historyId} (UUID)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ url: string
â”‚   â”œâ”€â”€ title: string
â”‚   â”œâ”€â”€ resultId: string
â”‚   â””â”€â”€ createdAt: Timestamp

conversation_results (è§£æçµæœ)
â”œâ”€â”€ {resultId} (UUID)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ historyId: string
â”‚   â”œâ”€â”€ checklist: ChecklistItem[]
â”‚   â”œâ”€â”€ generatedSummary: string
â”‚   â”œâ”€â”€ userIntent: string
â”‚   â”œâ”€â”€ intentAnswer: string
â”‚   â”œâ”€â”€ guidanceUnlocked: boolean
â”‚   â”œâ”€â”€ overview: Overview
â”‚   â”œâ”€â”€ createdAt: Timestamp
â”‚   â””â”€â”€ updatedAt: Timestamp

conversation_intermediates (ä¸­é–“è¡¨ç¾)
â”œâ”€â”€ {resultId} (UUID)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ historyId: string
â”‚   â”œâ”€â”€ resultId: string
â”‚   â”œâ”€â”€ intermediate: IntermediateRepresentation
â”‚   â””â”€â”€ createdAt: Timestamp

conversation_manga (æ¼«ç”»ç”Ÿæˆçµæœ)
â””â”€â”€ {resultId} (UUID)
    â”œâ”€â”€ userId: string
    â”œâ”€â”€ conversationId: string
    â”œâ”€â”€ resultId: string
    â”œâ”€â”€ status: string
    â”œâ”€â”€ panels: Panel[]
    â”œâ”€â”€ personalized: boolean
    â”œâ”€â”€ createdAt: Timestamp
    â””â”€â”€ completedAt: Timestamp
```

#### ãƒ‡ãƒ¼ã‚¿ã®é–¢é€£æ€§
```
historyId (1) â†â†’ (1) resultId
                    â†“
                 (0..1) intermediate
                    â†“
                 (0..1) manga
```

### 2.2 APIä»•æ§˜ã®è©³ç´°

#### POST /api/history - å±¥æ­´ä¿å­˜
**å‡¦ç†ã®æµã‚Œ**:
1. `requireUserId()` ã§èªè¨¼ãƒã‚§ãƒƒã‚¯
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ¤œè¨¼ï¼ˆ`resultId`, `url`, `title` ãŒå¿…é ˆï¼‰
3. `historyId` ãŒæœªæŒ‡å®šã®å ´åˆã€UUID ã‚’ç”Ÿæˆ
4. Firestore ã«3ã¤ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ï¼ˆå±¥æ­´ãƒ»çµæœãƒ»ä¸­é–“è¡¨ç¾ï¼‰

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**:
- âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆ`userId` ãŒå¿…é ˆï¼‰
- âœ… `userId` ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§è¨­å®šï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å€¤ã¯ä½¿ã‚ãªã„ï¼‰
- âš ï¸ `resultId` ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ãªã—ï¼ˆæ—¢å­˜ã® `resultId` ã‚’ä¸Šæ›¸ãã§ãã‚‹å¯èƒ½æ€§ï¼‰

#### DELETE /api/history/:historyId - å±¥æ­´å‰Šé™¤
**å‡¦ç†ã®æµã‚Œ**:
1. `requireUserId()` ã§èªè¨¼ãƒã‚§ãƒƒã‚¯
2. `historyId` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
3. æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ï¼ˆ`historyData.userId === userId`ï¼‰
4. Batch å‡¦ç†ã§å±¥æ­´ãƒ»çµæœãƒ»ä¸­é–“è¡¨ç¾ã‚’å‰Šé™¤

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**:
- âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯
- âœ… `historyId` ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
- âŒ `resultId` ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ãªã—
- âŒ `conversation_manga` ã®å‰Šé™¤ãªã—

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/[historyId]/route.ts:126-134
const batch = db.batch();
batch.delete(historyRef);

if (resultId) {
  batch.delete(db.collection(COLLECTIONS.results).doc(resultId));
  batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));
  // âš ï¸ conversation_manga ã¯å‰Šé™¤ã•ã‚Œãªã„
}

await batch.commit();
```

### 2.3 Firestore Security Rules

**ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ«**:
```javascript
// firestore.rules:13-16
match /conversation_histories/{historyId} {
  allow read, update, delete: if isOwner(resource.data.userId);
  allow create: if isOwner(request.resource.data.userId);
}

// firestore.rules:9-11
function isOwner(userId) {
  return isSignedIn() && request.auth.uid == userId;
}
```

**é‡è¦ãªç™ºè¦‹**: `request.auth.uid` ã¯ Firebase Auth ã® UID ã‚’å‚ç…§ã™ã‚‹ã€‚

#### Firebase Auth ã® request.auth ã®ä»•æ§˜
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ Firestore ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆ**: Firebase SDK ã§èªè¨¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒ `request.auth` ã«å…¥ã‚‹
- **`request.auth.uid`**: Firebase Authentication ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆFirebase UIDï¼‰
- **NextAuth ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³**: ã“ã‚Œã¨ã¯åˆ¥ã®ã‚·ã‚¹ãƒ†ãƒ 

#### å•é¡Œã®æ ¸å¿ƒ
```
ã€Firestore Rules ãŒæœŸå¾…ã™ã‚‹å€¤ã€‘
request.auth.uid = Firebase UID (ä¾‹: "abc123XYZ456def789")

ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã€‘
- Google OAuth ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆ:
  conversation_histories ã® userId = Google providerAccountId (ä¾‹: "103234567890123456789")

- Firebase ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆ:
  conversation_histories ã® userId = Firebase UID (ä¾‹: "abc123XYZ456def789")
```

**çµè«–**: Google OAuth ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ Firestore ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`request.auth.uid` ã¨ `userId` ãŒä¸€è‡´ã›ãšã€ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã•ã‚Œã‚‹ã€‚

---

## ğŸ‘¤ 3. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æƒ…å ±ç®¡ç†ã®è©³ç´°èª¿æŸ»

### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### Firestore `users` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
```
users
â””â”€â”€ {userId}
    â”œâ”€â”€ displayName: string
    â”œâ”€â”€ birthDate: Timestamp
    â”œâ”€â”€ gender: string
    â”œâ”€â”€ occupation: string
    â”œâ”€â”€ nationality: string
    â”œâ”€â”€ location: string
    â”œâ”€â”€ visualTraits: string
    â”œâ”€â”€ personality: string
    â””â”€â”€ updatedAt: Timestamp
```

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: `userId`ï¼ˆGoogle providerAccountId ã¾ãŸã¯ Firebase UIDï¼‰

### 3.2 APIä»•æ§˜

#### GET /api/user/profile - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
**å‡¦ç†ã®æµã‚Œ**:
```typescript
// src/app/api/user/profile/route.ts:5-43
1. auth() ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
2. session.user.id ã®å­˜åœ¨ç¢ºèª
3. Firestore ã‹ã‚‰ users/{session.user.id} ã‚’å–å¾—
4. Timestamp ã‚’ ISOæ–‡å­—åˆ—ã«å¤‰æ›
5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**:
- âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆ`session.user.id` ãŒå¿…é ˆï¼‰
- âœ… è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å–å¾—å¯èƒ½ï¼ˆ`session.user.id` ã‚’ç›´æ¥ä½¿ç”¨ï¼‰
- âœ… Admin SDK ä½¿ç”¨ï¼ˆFirestore Rules ã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰

#### PUT /api/user/profile - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
**å‡¦ç†ã®æµã‚Œ**:
```typescript
// src/app/api/user/profile/route.ts:46-81
1. auth() ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
2. session.user.id ã®å­˜åœ¨ç¢ºèª
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
4. birthDate ã‚’ Date å‹ã«å¤‰æ›
5. updatedAt ã‚’ç¾åœ¨æ™‚åˆ»ã«è¨­å®š
6. Firestore ã«ä¿å­˜ï¼ˆmerge: trueï¼‰
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**:
- âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯
- âœ… è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿æ›´æ–°å¯èƒ½
- âš ï¸ å…¥åŠ›å€¤ã®æ¤œè¨¼ãŒä¸ååˆ†ï¼ˆå‹ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
- âš ï¸ XSSå¯¾ç­–ãŒä¸æ˜ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§å¯¾å¿œã—ã¦ã„ã‚‹å‰æï¼‰

### 3.3 Firestore Security Rules

**ç¾åœ¨ã®çŠ¶æ…‹**: âŒ **ãƒ«ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„**

```javascript
// firestore.rules ã«ã¯ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„
```

**å½±éŸ¿**:
- Admin SDK ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹: âœ… å•é¡Œãªã—ï¼ˆRules ã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹: âŒ **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ‹’å¦**ã•ã‚Œã‚‹ï¼ˆæ˜ç¤ºçš„ãª allow ãŒãªã„ãŸã‚ï¼‰

**æ³¨æ„**: Firestore ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«ã¯ã€Œã™ã¹ã¦æ‹’å¦ã€ãªã®ã§ã€ç¾çŠ¶ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚ã—ã‹ã—ã€å°†æ¥çš„ã« Rules ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€é©åˆ‡ãªåˆ¶é™ãŒå¿…è¦ã€‚

### 3.4 ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºæ©Ÿèƒ½ã§ã®åˆ©ç”¨

#### ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²
   â†“
2. Firestore users/{userId} ã«ä¿å­˜
   â†“
3. æ¼«ç”»ç”Ÿæˆæ™‚ã« getUserProfileFromFirestore(userId) ã§å–å¾—
   â†“
4. normalizeUserProfile() ã§æ­£è¦åŒ–ï¼ˆå¹´é½¢è¨ˆç®—ã€å›½ç±åˆ¤å®šãªã©ï¼‰
   â†“
5. PersonalizationInput ã¨ã—ã¦ Gemini API ã«é€ä¿¡
   â†“
6. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ¼«ç”»ã‚’ç”Ÿæˆ
```

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/lib/user-profile.ts:28-44
export async function getUserProfileFromFirestore(
  userId: string
): Promise<RawUserProfile | null> {
  const db = getAdminFirestore();
  const docRef = db.collection('users').doc(userId);
  const docSnap = await docRef.get();

  if (!docSnap.exists) {
    return null;
  }

  return docSnap.data() as RawUserProfile;
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡**:
- âœ… Admin SDK ä½¿ç”¨ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ï¼‰
- âœ… `userId` ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§å–å¾—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æŒ‡å®šã§ããªã„ï¼‰
- âœ… è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‚ç…§å¯èƒ½

---

## ğŸ” 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã®è©³ç´°

### 4.1 èªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åº¦

| é …ç›® | è©•ä¾¡ | è©³ç´° |
|-----|------|------|
| JWT ç½²å | âœ… å¼·å›º | HS256 + AUTH_SECRET ã§ç½²å |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³æ”¹ã–ã‚“é˜²æ­¢ | âœ… å¼·å›º | JWT æ¤œè¨¼ã«ã‚ˆã‚Šæ”¹ã–ã‚“æ¤œçŸ¥ |
| ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ | âœ… é©åˆ‡ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30æ—¥ï¼ˆèª¿æ•´å¯èƒ½ï¼‰ |
| HTTPS é€šä¿¡ | âœ… å¿…é ˆ | Cloud Run ã¯ HTTPS å¼·åˆ¶ |
| XSS å¯¾ç­– | âš ï¸ ä¸æ˜ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ¬¡ç¬¬ |
| CSRF å¯¾ç­– | âœ… å®Ÿè£…æ¸ˆã¿ | NextAuth ãŒè‡ªå‹•å¯¾å¿œ |

### 4.2 ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

#### ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡å±¤
```
ã€Layer 1ã€‘ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- src/middleware.ts ã§ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
- æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ /login ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

ã€Layer 2ã€‘API èªè¨¼
- requireUserId() ã§èªè¨¼ãƒã‚§ãƒƒã‚¯
- æœªèªè¨¼ã¯ 401 ã‚¨ãƒ©ãƒ¼

ã€Layer 3ã€‘æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯
- userId ã«ã‚ˆã‚‹æ‰€æœ‰è€…ç¢ºèª
- ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã¯ 403 ã‚¨ãƒ©ãƒ¼

ã€Layer 4ã€‘Firestore Rulesï¼ˆç¾åœ¨ã¯æœªä½¿ç”¨ï¼‰
- Admin SDK ã¯ Rules ã‚’ãƒã‚¤ãƒ‘ã‚¹
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ã¿æœ‰åŠ¹
```

**é˜²å¾¡ã®æ·±ã•ï¼ˆDefense in Depthï¼‰è©•ä¾¡**:
- âœ… å¤šå±¤é˜²å¾¡ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- âš ï¸ Firestore Rules ãŒå®Ÿè³ªçš„ã«æ©Ÿèƒ½ã—ã¦ã„ãªã„ï¼ˆLayer 4ãŒæ¬ è½ï¼‰

### 4.3 ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®å®Œå…¨æ€§

#### ç¾åœ¨ã®å‰Šé™¤å‡¦ç†
```typescript
DELETE /api/history/:historyId
  â†“
conversation_histories ã®å‰Šé™¤ âœ…
  â†“
conversation_results ã®å‰Šé™¤ âœ…
  â†“
conversation_intermediates ã®å‰Šé™¤ âœ…
  â†“
conversation_manga ã®å‰Šé™¤ âŒ â† å‰Šé™¤ã•ã‚Œãªã„
  â†“
Cloud Storage ã®ç”»åƒå‰Šé™¤ âŒ â† å‰Šé™¤ã•ã‚Œãªã„
```

**GDPR / å€‹äººæƒ…å ±ä¿è­·æ³•ã¸ã®å½±éŸ¿**:
- **å‰Šé™¤æ¨©ï¼ˆRight to Erasureï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã‚’è¦æ±‚ã—ãŸå ´åˆã€ã™ã¹ã¦ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **ç¾çŠ¶**: æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ã¨ç”»åƒãŒæ®‹å­˜ã™ã‚‹ãŸã‚ã€å®Œå…¨ãªå‰Šé™¤ãŒã§ãã¦ã„ãªã„
- **ãƒªã‚¹ã‚¯**: æ³•ä»¤é•åã®å¯èƒ½æ€§

### 4.4 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒªã‚¹ã‚¯è©•ä¾¡

#### ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€‹äººæƒ…å ±ã®ç¨®é¡
| ãƒ‡ãƒ¼ã‚¿ | å ´æ‰€ | æ©Ÿå¯†æ€§ | ç”¨é€” |
|-------|-----|--------|------|
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | NextAuth ã‚»ãƒƒã‚·ãƒ§ãƒ³ | ä¸­ | èªè¨¼ |
| æ°å | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ä¸­ | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« |
| ç”Ÿå¹´æœˆæ—¥ | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | é«˜ | å¹´é½¢è¨ˆç®— |
| æ€§åˆ¥ | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ä¸­ | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º |
| è·æ¥­ | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ä½ | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º |
| å›½ç± | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ä¸­ | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º |
| å±…ä½åœ° | users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ | ä¸­ | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º |
| ä¼šè©±å±¥æ­´ | conversation_* | ä¸­ | ã‚µãƒ¼ãƒ“ã‚¹æä¾› |
| æ¤œç´¢URL | conversation_histories | ä½ | å±¥æ­´è¡¨ç¤º |

**æ©Ÿå¯†æ€§ã®å®šç¾©**:
- **é«˜**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã§é‡å¤§ãªè¢«å®³ï¼ˆãªã‚Šã™ã¾ã—ã€å·®åˆ¥ãªã©ï¼‰
- **ä¸­**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³
- **ä½**: å…¬é–‹æƒ…å ±ã«è¿‘ã„

**ç¾åœ¨ã®ä¿è­·çŠ¶æ…‹**:
- âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒèªè¨¼ãƒ»æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ã§ä¿è­·
- âœ… Admin SDK ã®ã¿ã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
- âš ï¸ å‰Šé™¤ãŒä¸å®Œå…¨ï¼ˆæ¼«ç”»ãƒ‡ãƒ¼ã‚¿ãŒæ®‹å­˜ï¼‰

---

## ğŸ› ï¸ 5. æŠ€è¡“çš„ãªä¿®æ­£æ¡ˆ

### 5.1 èªè¨¼IDçµ±ä¸€ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: ã™ã¹ã¦ã®èªè¨¼ã‚’ Firebase Auth ã«çµ±ä¸€ï¼ˆæ¨å¥¨ï¼‰

**å¤‰æ›´ç‚¹**:
1. Google OAuth ã‚‚ Firebase Authentication ã® Google ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨
2. NextAuth ã‚’å‰Šé™¤ã—ã€Firebase SDK ã®ã¿ã§èªè¨¼
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ Firebase ID ãƒˆãƒ¼ã‚¯ãƒ³ã§è¡Œã†

**ãƒ¡ãƒªãƒƒãƒˆ**:
- `userId` ãŒ Firebase UID ã§çµ±ä¸€ã•ã‚Œã‚‹
- Firestore Rules ã¨å®Œå…¨ã«æ•´åˆ
- å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- NextAuth ã®æ©Ÿèƒ½ãŒä½¿ãˆãªããªã‚‹
- å¤§è¦æ¨¡ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦

**å®Ÿè£…ä¾‹**:
```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
import { getAuth, signInWithPopup, GoogleAuthProvider } from 'firebase/auth';

const auth = getAuth();
const provider = new GoogleAuthProvider();

const result = await signInWithPopup(auth, provider);
const idToken = await result.user.getIdToken();

// API å‘¼ã³å‡ºã—æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
fetch('/api/protected', {
  headers: {
    Authorization: `Bearer ${idToken}`
  }
});
```

```typescript
// ã‚µãƒ¼ãƒãƒ¼å´
import { verifyIdToken } from '@/lib/firebase-admin';

export async function middleware(request: Request) {
  const token = request.headers.get('Authorization')?.replace('Bearer ', '');
  const decodedToken = await verifyIdToken(token);
  // decodedToken.uid ãŒ userId
}
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã§çµ±ä¸€

**å¤‰æ›´ç‚¹**:
1. Firebase Auth ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã« `providerAccountId` ã‚’è¿½åŠ 
2. Firestore Rules ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼

**ãƒ¡ãƒªãƒƒãƒˆ**:
- NextAuth ã‚’ç¶™ç¶šä½¿ç”¨ã§ãã‚‹
- å¤‰æ›´ç¯„å›²ãŒå°ã•ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã®ç®¡ç†ãŒè¤‡é›‘
- Firebase Admin SDK ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**å®Ÿè£…ä¾‹**:
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¨­å®š
import { getAdminAuth } from '@/lib/firebase-admin';

await getAdminAuth().setCustomUserClaims(firebaseUid, {
  providerAccountId: googleProviderAccountId
});
```

```javascript
// firestore.rules
function isOwner(userId) {
  return isSignedIn() && (
    request.auth.uid == userId ||
    request.auth.token.providerAccountId == userId
  );
}
```

### 5.2 å‰Šé™¤å‡¦ç†ã®å®Œå…¨åŒ–

**ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/[historyId]/route.ts
export async function DELETE(
  _request: NextRequest,
  context: { params: Promise<{ historyId: string }> }
) {
  const userId = await requireUserId();
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { historyId } = await context.params;
  const db = getAdminFirestore();
  const historyRef = db.collection(COLLECTIONS.histories).doc(historyId);
  const historySnap = await historyRef.get();

  if (!historySnap.exists) {
    return NextResponse.json({ error: 'Not found' }, { status: 404 });
  }

  const historyData = historySnap.data();
  if (!historyData || historyData.userId !== userId) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const resultId = historyData.resultId as string | undefined;

  // ã€ä¿®æ­£1ã€‘resultId ã®æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
  if (resultId) {
    const resultRef = db.collection(COLLECTIONS.results).doc(resultId);
    const resultSnap = await resultRef.get();

    if (resultSnap.exists) {
      const resultData = resultSnap.data();
      if (resultData?.userId !== userId) {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
      }
    }
  }

  const batch = db.batch();
  batch.delete(historyRef);

  if (resultId) {
    batch.delete(db.collection(COLLECTIONS.results).doc(resultId));
    batch.delete(db.collection(COLLECTIONS.intermediates).doc(resultId));

    // ã€ä¿®æ­£2ã€‘conversation_manga ã‚‚å‰Šé™¤
    batch.delete(db.collection('conversation_manga').doc(resultId));
  }

  await batch.commit();

  // ã€ä¿®æ­£3ã€‘Cloud Storage ã®ç”»åƒã‚‚å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if (resultId) {
    try {
      const storage = getAdminStorage();
      const bucket = storage.bucket();
      await bucket.deleteFiles({ prefix: `manga/${resultId}/` });
    } catch (error) {
      console.error('Failed to delete storage files:', error);
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šé™¤å¤±æ•—ã¯ãƒ­ã‚°ã®ã¿ï¼ˆFirestoreã¯å‰Šé™¤æ¸ˆã¿ï¼‰
    }
  }

  return NextResponse.json({ deleted: true, historyId, resultId: resultId ?? null });
}
```

### 5.3 requireUserId() ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

**ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰**:
```typescript
// src/app/api/history/utils.ts
export async function requireUserId(): Promise<string> {
  const session = await auth();
  if (!session?.user?.id) {
    throw new UnauthorizedError('User not authenticated');
  }
  return session.user.id;
}

// ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
export class UnauthorizedError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'UnauthorizedError';
  }
}
```

**API ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¿®æ­£**:
```typescript
// src/app/api/history/route.ts
export async function GET(request: NextRequest) {
  try {
    const userId = await requireUserId();  // ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

    // ä»¥é™ã¯ userId ãŒå¿…ãšå­˜åœ¨ã™ã‚‹
    const db = getAdminFirestore();
    // ...

  } catch (error) {
    if (error instanceof UnauthorizedError) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    throw error;  // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯å†ã‚¹ãƒ­ãƒ¼
  }
}
```

---

## ğŸ“ˆ 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### 6.1 ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢

| é …ç›® | ã‚¹ã‚³ã‚¢ | è©•ä¾¡ |
|-----|--------|------|
| èªè¨¼ã®å¼·åº¦ | 9/10 | JWTç½²åã€HTTPSé€šä¿¡ |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | 7/10 | æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ã‚ã‚Šã€Firestore RulesãŒä¸æ•´åˆ |
| ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | 5/10 | ä¸å®Œå…¨ãªå‰Šé™¤å‡¦ç† |
| ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­· | 7/10 | Admin SDK ã§ä¿è­·ã€å‰Šé™¤ãŒä¸å®Œå…¨ |
| ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ | 6/10 | GDPRå¯¾å¿œãŒä¸å®Œå…¨ |
| **ç·åˆã‚¹ã‚³ã‚¢** | **6.8/10** | **è‰¯å¥½ã ãŒæ”¹å–„ã®ä½™åœ°ã‚ã‚Š** |

### 6.2 ãƒªã‚¹ã‚¯ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒªã‚¹ã‚¯ | ç™ºç”Ÿç¢ºç‡ | å½±éŸ¿åº¦ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
|-------|---------|--------|-------------|
| Firestore Rules ä¸æ•´åˆ | ä½ï¼ˆç¾åœ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰ | é«˜ | ğŸŸ¡ ä¸­ |
| users ãƒ«ãƒ¼ãƒ«æœªå®šç¾© | ä½ï¼ˆç¾åœ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰ | é«˜ | ğŸŸ¡ ä¸­ |
| å‰Šé™¤ä¸å®Œå…¨ | é«˜ï¼ˆç¾åœ¨ç™ºç”Ÿä¸­ï¼‰ | ä¸­ | ğŸŸ¡ ä¸­ |
| èªè¨¼IDåˆ†æ–­ | ä¸­ï¼ˆç•°ãªã‚‹èªè¨¼æ–¹æ³•ã‚’ä½¿ã†å¯èƒ½æ€§ï¼‰ | ä¸­ | ğŸŸ  ä¸­-ä½ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã— | ä½ï¼ˆç¾åœ¨å°è¦æ¨¡ï¼‰ | ä½ | ğŸŸ¢ ä½ |

---

## ğŸ“š 7. å‚è€ƒè³‡æ–™

### 7.1 å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [NextAuth.js Documentation](https://authjs.dev/)
- [Firebase Authentication](https://firebase.google.com/docs/auth)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [GCP Identity Platform](https://cloud.google.com/identity-platform/docs)

### 7.2 ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [GDPR Compliance](https://gdpr.eu/)
- [å€‹äººæƒ…å ±ä¿è­·æ³•](https://www.ppc.go.jp/)

### 7.3 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª²é¡Œ](./ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª²é¡Œ.md)
- [èªè¨¼æ©Ÿèƒ½è¨­è¨ˆæ›¸](../auth/èªè¨¼æ©Ÿèƒ½è¨­è¨ˆæ›¸.md)
- [ä¼šè©±å±¥æ­´æ©Ÿèƒ½ è¨­è¨ˆæ›¸](../conversation-history/design.md)

---

**æœ€çµ‚æ›´æ–°**: 2026-02-08
