# KOMANAVI デプロイ手順書（認証機能対応版）

## 概要

KOMANAVIアプリケーションを認証機能付きでCloud Runにデプロイする手順です。

## 対象環境

| 項目 | 値 |
|------|-----|
| サービス名 | komanavi |
| リージョン | asia-northeast1 |
| 本番URL | https://komanavi-30981781876.asia-northeast1.run.app |
| GCPプロジェクトID | zenn-ai-agent-hackathon-vol4 |

---

## 前提条件

- gcloud CLI がインストール・認証済み
- Docker がインストール済み
- GCPプロジェクトへのオーナー権限

---

## デプロイ手順

### Step 1: Secret Manager の設定

```bash
# 1-1. Secret Manager API 有効化
gcloud services enable secretmanager.googleapis.com --project=zenn-ai-agent-hackathon-vol4

# 1-2. シークレット作成（3つ）
# AUTH_SECRET
echo -n '<AUTH_SECRET>' | \
  gcloud secrets create auth-secret --data-file=- --replication-policy="automatic" \
  --project=zenn-ai-agent-hackathon-vol4

# AUTH_GOOGLE_ID
echo -n '<AUTH_GOOGLE_ID>' | \
  gcloud secrets create auth-google-id --data-file=- --replication-policy="automatic" \
  --project=zenn-ai-agent-hackathon-vol4

# AUTH_GOOGLE_SECRET
echo -n '<AUTH_GOOGLE_SECRET>' | \
  gcloud secrets create auth-google-secret --data-file=- --replication-policy="automatic" \
  --project=zenn-ai-agent-hackathon-vol4

# 1-3. サービスアカウントにシークレットアクセス権限を付与
for secret in auth-secret auth-google-id auth-google-secret; do
  gcloud secrets add-iam-policy-binding $secret \
    --member="serviceAccount:komanavi-cloud-run@zenn-ai-agent-hackathon-vol4.iam.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=zenn-ai-agent-hackathon-vol4
done
```

> **注意**: シークレットが既に存在する場合は、作成コマンドをスキップしてください。

### Step 2: Firebase Admin 権限の付与

```bash
gcloud projects add-iam-policy-binding zenn-ai-agent-hackathon-vol4 \
  --member="serviceAccount:komanavi-cloud-run@zenn-ai-agent-hackathon-vol4.iam.gserviceaccount.com" \
  --role="roles/firebase.admin"
```

### Step 3: Docker イメージのビルド

```bash
# 3-1. Artifact Registry への認証
gcloud auth configure-docker asia-northeast1-docker.pkg.dev

# 3-2. プロジェクトルートに移動
cd <自分のローカルプロジェクトのパス>

# 3-3. イメージをビルド（ビルド引数付き）
docker build \
  --build-arg NEXT_PUBLIC_FIREBASE_API_KEY=<Firebase APIキー> \
  --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=zenn-ai-agent-hackathon-vol4.firebaseapp.com \
  --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID=zenn-ai-agent-hackathon-vol4 \
  -t asia-northeast1-docker.pkg.dev/zenn-ai-agent-hackathon-vol4/cloud-run-source-deploy/komanavi:latest \
  .

# 3-4. イメージをプッシュ
docker push asia-northeast1-docker.pkg.dev/zenn-ai-agent-hackathon-vol4/cloud-run-source-deploy/komanavi:latest
```

### Step 4: Cloud Run デプロイ

```bash
gcloud run deploy komanavi \
  --image=asia-northeast1-docker.pkg.dev/zenn-ai-agent-hackathon-vol4/cloud-run-source-deploy/komanavi:latest \
  --region=asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars="GCP_PROJECT_ID=zenn-ai-agent-hackathon-vol4,GCP_LOCATION=global,FIREBASE_PROJECT_ID=zenn-ai-agent-hackathon-vol4,AUTH_URL=https://komanavi-30981781876.asia-northeast1.run.app" \
  --set-secrets="AUTH_SECRET=auth-secret:latest,AUTH_GOOGLE_ID=auth-google-id:latest,AUTH_GOOGLE_SECRET=auth-google-secret:latest" \
  --project=zenn-ai-agent-hackathon-vol4
```

### Step 5: Google OAuth リダイレクトURI 設定（手動）

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 「APIとサービス」→「認証情報」を選択
3. OAuth 2.0 クライアントID を編集
4. 以下を追加:

| 設定項目 | 値 |
|---------|-----|
| 承認済みのリダイレクトURI | `https://komanavi-30981781876.asia-northeast1.run.app/api/auth/callback/google` |
| 承認済みのJavaScript生成元 | `https://komanavi-30981781876.asia-northeast1.run.app` |

---

## 検証方法

1. https://komanavi-30981781876.asia-northeast1.run.app にアクセス
2. ログインページが表示されることを確認
3. Googleログインボタンをクリック
4. Google認証後、アプリにリダイレクトされることを確認
5. `/analyze` ページにアクセスできることを確認

---

## トラブルシューティング

### シークレットが既に存在するエラー

```
ERROR: (gcloud.secrets.create) ALREADY_EXISTS: Secret [auth-secret] already exists.
```

→ シークレットは既に作成済みです。次のステップに進んでください。

### Docker ビルドエラー

```
ERROR: failed to solve: process ... with exit code: 1
```

→ `npm run build` が失敗している可能性があります。ローカルで `npm run build` を実行してエラーを確認してください。

### Cloud Run デプロイ後に認証エラー

```
OAuthAccountNotLinked
```

→ Google OAuth のリダイレクトURIが正しく設定されているか確認してください（Step 5）。

---

## 環境変数一覧

### ビルド時（Dockerfile ARG）

| 変数名 | 説明 |
|--------|------|
| NEXT_PUBLIC_FIREBASE_API_KEY | Firebase API キー |
| NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN | Firebase 認証ドメイン |
| NEXT_PUBLIC_FIREBASE_PROJECT_ID | Firebase プロジェクトID |

### 実行時（Cloud Run 環境変数）

| 変数名 | 説明 |
|--------|------|
| GCP_PROJECT_ID | GCPプロジェクトID |
| GCP_LOCATION | Vertex AI のロケーション |
| FIREBASE_PROJECT_ID | Firebase プロジェクトID |
| AUTH_URL | 認証用のベースURL |

### 実行時（Cloud Run シークレット）

| シークレット名 | 環境変数名 | 説明 |
|--------------|-----------|------|
| auth-secret | AUTH_SECRET | NextAuth.js のシークレットキー |
| auth-google-id | AUTH_GOOGLE_ID | Google OAuth クライアントID |
| auth-google-secret | AUTH_GOOGLE_SECRET | Google OAuth クライアントシークレット |

---

## 更新履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-01-24 | 初版作成（認証機能対応版） |
